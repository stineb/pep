---
title: "Analysis for the phenology paper"
author: "Laura Marques"
date: "8/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(broom)
library(rbeni)
library(lme4) #lmer
library(MuMIn) #r.squaredGLMM
library(lmerTest) #p-values
library(effects) #plot effects
library(sjPlot) #plot effects
library(patchwork)

## functions to convert lmer effects plots to ggplot objects
ggplot_on <- function(x){
  df <- tibble(upper = x$`scale(on)`$upper[,1],
               lower = x$`scale(on)`$lower[,1],
               off = x$`scale(on)`$fit[,1],
               on = x$`scale(on)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = on, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(on, off), col = "royalblue") +
    theme_classic() +
    labs(x = "SOS (DOY)", y = "EOS (DOY)")
  return(gg)
}

ggplot_year <- function(x){
  df <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(year, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Year", y = "EOS (DOY)")
  return(gg)
}

ggplot_year0 <- function(x){
  df <- tibble(upper = x$`year`$upper[,1],
               lower = x$`year`$lower[,1],
               off = x$`year`$fit[,1],
               year = x$`year`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(year, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Year", y = "EOS (DOY)")
  return(gg)
}

ggplot_cA_tot <- function(x){
  df <- tibble(upper = x$`scale(cA_tot)`$upper[,1],
               lower = x$`scale(cA_tot)`$lower[,1],
               off = x$`scale(cA_tot)`$fit[,1],
               cA_tot = x$`scale(cA_tot)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = cA_tot, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(cA_tot, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

ggplot_gpp_net <- function(x){
  df <- tibble(upper = x$`scale(gpp_net)`$upper[,1],
               lower = x$`scale(gpp_net)`$lower[,1],
               off   = x$`scale(gpp_net)`$fit[,1],
               gpp_net = x$`scale(gpp_net)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = gpp_net, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(gpp_net, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

ggplot_year_anet <- function(x, y){
  df <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1]) %>% 
    bind_rows(
      tibble(upper = y$`scale(year)`$upper[,1],
             lower = y$`scale(year)`$lower[,1],
             anet   = y$`scale(year)`$fit[,1],
             year = y$`scale(year)`$x[,1])
    )
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(year, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Year", y = "EOS (DOY)")
  return(gg)
}

ggplot_mean_gpp_net <- function(x){
  df <- tibble(upper = x$`scale(mean_gpp_net)`$upper[,1],
               lower = x$`scale(mean_gpp_net)`$lower[,1],
               off = x$`scale(mean_gpp_net)`$fit[,1],
               mean_gpp_net = x$`scale(mean_gpp_net)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = mean_gpp_net, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(mean_gpp_net, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste("Mean " ,italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  return(gg)
}

ggplot_anom_gpp_net <- function(x){
  df <- tibble(upper = x$`scale(anom_gpp_net)`$upper[,1],
               lower = x$`scale(anom_gpp_net)`$lower[,1],
               off   = x$`scale(anom_gpp_net)`$fit[,1],
               anom_gpp_net = x$`scale(anom_gpp_net)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = anom_gpp_net, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(anom_gpp_net, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste("Anomalies " ,italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

```

## Load data

### Zani et al. data

Data from PEP pheno and LPJ-GUESS photosynthesis

Read the data complemented with drivers, obtained from Constantin Zohner (7.12.2020).
```{r}
df <- data.table::fread("~/data/pep/processed/DataMeta_3_Drivers_20_11_10.csv") %>% 
  as_tibble() %>% 
  rename(lon = LON, lat = LAT, year = YEAR, off = DoY_off, on = DoY_out, 
         anom_off_zani = autumn_anomaly, anom_on_zani = spring_anomaly, 
         species = Species, id_site = PEP_ID, id_species_site = timeseries)
```

Taking uncorrected Zani
```{r}
df_anl_Zani <- df
```

### P-model outputs data

Data from PEP pheno and P-model photosynthesis

```{r}
load("~/data/pep/processed/df_pmodel_zani.RData")

df_anl <- df_pmodel_zani %>% 
  unnest(out_pmodel) %>% 
  right_join(df_anl_Zani, by = c("id_species_site", "year")) %>% 
  mutate(gpp_net = gpp - rd,
         lue = gpp / apar)
```

Check consistency of P-model and LPJ-GUESS GPP.
```{r}
out <- df_anl %>% 
  analyse_modobs2("cA_tot", "gpp_net", type = "heat")
out$gg
```

### MODIS P-model outputs

Data from MODIS pheno and P-model photosynthesis

```{r}
# Read phenology dates from MODIS
modis_pheno_sites <- readRDS("~/pep/data/modis_phenology/modis_pheno_sites.rds")
# Read p-model outputs
modis_pmodel <- readRDS("~/pep/data/pmodel_output/modis_pmodel_output.rds")
modis_pmodel <- modis_pmodel %>% mutate(gpp_net = gpp - rd, lue = gpp / apar)
# Join datasets
df_anl_modis <- modis_pheno_sites %>% 
  left_join(modis_pmodel[,2:10], by = c("lon","lat","year"))
# Change variable names
df_anl_modis <- df_anl_modis %>% rename(on = SOS_2_doy, off = EOS_2_doy) # Select the band
#df_anl_modis <- df_anl_modis %>% filter(off>on)
```

## Data volume

Distribution of number of data points per time series.
```{r}
df_ndata <- df_anl %>% 
  group_by(id_species_site) %>% 
  summarise(count = n())

quantile(df_ndata$count, probs = c(0.5, 0.9))

df_ndata %>% 
  ggplot(aes(count, ..count..)) +
  geom_histogram(bins = 20) +
  xlab("N data points per time series (years)") +
  labs(title = "PEP725 phenology time series lengthts")
```

## Zani et al. data

### Interannual variation (IAV)

#### Start-of-Season (SOS)

```{r}
fit_iav_zz_on = lmer(off ~ scale(on) + (1|id_site) + (1|species) , data = df_anl_Zani, na.action = "na.exclude")
summary(fit_iav_zz_on)
r.squaredGLMM(fit_iav_zz_on)
plot(allEffects(fit_iav_zz_on))

aic_iav_zz_on <- AIC(fit_iav_zz_on)
out_plot <- allEffects(fit_iav_zz_on)
gg_iav_zz_on <- ggplot_on(out_plot)
gg_iav_zz_on
```

#### Anet LPJ (Fig 1A)

```{r}
fit_iav_zz_cAtot = lmer(off ~ scale(cA_tot) + (1|id_site) + (1|species) , data = df_anl_Zani, na.action = "na.exclude")
summary(fit_iav_zz_cAtot)
r.squaredGLMM(fit_iav_zz_cAtot)
plot(allEffects(fit_iav_zz_cAtot))

aic_iav_zz_cAtot <- AIC(fit_iav_zz_cAtot)
out_plot <- allEffects(fit_iav_zz_cAtot)
gg_iav_zz_cAtot <- ggplot_cA_tot(out_plot)
gg_iav_zz_cAtot
```

##### Running mean Anet LPJ

```{r}
df_anl_Zani <- df_anl_Zani %>% 
  mutate(cA_tot_rm2 = data.table::frollmean(cA_tot, 2),
         cA_tot_rm3 = data.table::frollmean(cA_tot, 3),
         cA_tot_rm5 = data.table::frollmean(cA_tot, 5),
         cA_tot_rm10 = data.table::frollmean(cA_tot, 10))

fit2 = lmer(off ~ scale(cA_tot_rm2) + (1|id_site) + (1|species) , data = df_anl_Zani, na.action = "na.exclude")
fit3 = lmer(off ~ scale(cA_tot_rm3) + (1|id_site) + (1|species) , data = df_anl_Zani, na.action = "na.exclude")
fit5 = lmer(off ~ scale(cA_tot_rm5) + (1|id_site) + (1|species) , data = df_anl_Zani, na.action = "na.exclude")
fit10 = lmer(off ~ scale(cA_tot_rm10) + (1|id_site) + (1|species) , data = df_anl_Zani, na.action = "na.exclude")

out_plot2 <- allEffects(fit2)
out_plot3 <- allEffects(fit3)
out_plot5 <- allEffects(fit5)
out_plot10 <- allEffects(fit10)

ggplot_cA_tot_rm <- function(out_plot2, out_plot3, out_plot5, out_plot10){
    
  df <- tibble(upper = out_plot2$`scale(cA_tot_rm2)`$upper[,1],
               lower = out_plot2$`scale(cA_tot_rm2)`$lower[,1],
               off = out_plot2$`scale(cA_tot_rm2)`$fit[,1],
               cA_tot = out_plot2$`scale(cA_tot_rm2)`$x[,1]) %>% 
    mutate(nyears = 2) %>% 
    bind_rows(
      tibble(upper = out_plot3$`scale(cA_tot_rm3)`$upper[,1],
               lower = out_plot3$`scale(cA_tot_rm3)`$lower[,1],
               off = out_plot3$`scale(cA_tot_rm3)`$fit[,1],
               cA_tot = out_plot3$`scale(cA_tot_rm3)`$x[,1]) %>% 
    mutate(nyears = 3)
    ) %>% 
    bind_rows(
      tibble(upper = out_plot5$`scale(cA_tot_rm5)`$upper[,1],
               lower = out_plot5$`scale(cA_tot_rm5)`$lower[,1],
               off = out_plot5$`scale(cA_tot_rm5)`$fit[,1],
               cA_tot = out_plot5$`scale(cA_tot_rm5)`$x[,1]) %>% 
    mutate(nyears = 5)
    ) %>% 
    bind_rows(
      tibble(upper = out_plot10$`scale(cA_tot_rm10)`$upper[,1],
               lower = out_plot10$`scale(cA_tot_rm10)`$lower[,1],
               off = out_plot10$`scale(cA_tot_rm10)`$fit[,1],
               cA_tot = out_plot10$`scale(cA_tot_rm10)`$x[,1]) %>% 
    mutate(nyears = 10)
    )
  
  gg <- ggplot() + 
    # geom_ribbon(data = df, aes(x = cA_tot, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(x = cA_tot, y = off, color = nyears, group = nyears)) +
    theme_classic() +
    labs(x = expression(paste(italic("A")[net], " (gC m"^-2, "yr"^-2, ")")), y = "EOS (DOY)")
}

gg_2yr_zz <- ggplot_cA_tot_rm(out_plot2, out_plot3, out_plot5, out_plot10)
gg_2yr_zz
```

### Long-term (year)

#### SOS

```{r}
fit_lt_zz_on = lmer(off ~ scale(on) + scale(year) + (1|id_site) + (1|species), data = df_anl_Zani, na.action = "na.exclude")
summary(fit_lt_zz_on)
r.squaredGLMM(fit_lt_zz_on)
plot(allEffects(fit_lt_zz_on))

aic_lt_zz_on <- AIC(fit_lt_zz_on)
out_plot <- allEffects(fit_lt_zz_on)
gg_lt_zz_on <- ggplot_on(out_plot)
gg_lt_zz_year <- ggplot_year(out_plot)

gg_lt_zz_on + gg_lt_zz_year
```

Long-term trend in SOS.

```{r}
fit_on_year <- lmer(on ~ scale(year) + (1|id_site) + (1|species), data = df_anl_Zani, na.action = "na.exclude")
summary(fit_on_year)

out_plot <- allEffects(fit_on_year)
gg_zz_on_year <- ggplot_year(out_plot)
gg_zz_on_year <- gg_zz_on_year + ylab("SOS (DOY)") 
gg_zz_on_year
```

#### Anet LPJ (New Fig 1B and 1C, old Fig 1C and 1D)

```{r}
fit_lt_zz_cAtot = lmer(off ~ scale(cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl_Zani, na.action = "na.exclude")
summary(fit_lt_zz_cAtot)
r.squaredGLMM(fit_lt_zz_cAtot)
plot(allEffects(fit_lt_zz_cAtot))

aic_lt_zz_cAtot <- AIC(fit_lt_zz_cAtot)
out_plot_lt <- allEffects(fit_lt_zz_cAtot)
gg_lt_zz_cAtot <- ggplot_cA_tot(out_plot_lt)
gg_lt_zz_year <- ggplot_year(out_plot_lt)

gg_lt_zz_cAtot + gg_lt_zz_year
```

Is this better model than EOS ~ Anet?

```{r}
out_anova <- anova(fit_iav_zz_cAtot, fit_lt_zz_cAtot)
out_anova
```

#### Long-term trend in Anet.(New Fig 1C red, old Fig 1D red)

```{r}
#fit_anet_year <- lmer(cA_tot ~ scale(year) + (1|id_site) + (1|species), data = df_anl_Zani, na.action = "na.exclude")
fit_cAtot_year <- lmer(cA_tot ~ year + (1|id_site) + (1|species), data = df_anl_Zani, na.action = "na.exclude")
summary(fit_cAtot_year)
plot(allEffects(fit_cAtot_year))

out_plot_cAtot <- allEffects(fit_cAtot_year)
gg_lt_cAtot_year <- ggplot_year0(out_plot_cAtot)
gg_lt_cAtot_year <- gg_lt_cAtot_year + 
  labs(y = expression(italic("A")[net]))
gg_lt_cAtot_year
```

##### Plot dual figure

```{r}
ggplot_year_cAtot <- function(x, y){
  
  df1 <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1])
  df2 <- tibble(upper = y$`year`$upper[,1],
             lower = y$`year`$lower[,1],
             anet = y$`year`$fit[,1],
             year = y$`year`$x[,1])
  
  coef <- 0.7 * mean(df1$off) / mean(df2$anet)
  
  # library(grid)
  # t1 <- textGrob(expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"))), x = 0, y = 1.1, gp = gpar(col = "black"))
  
  gg <- ggplot() + 
    geom_ribbon(data = df1, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df1, aes(x = year, y = off), col = "royalblue") +
    
    geom_ribbon(data = df2, aes(x = year, ymin = lower * coef + 100, ymax = upper * coef + 100), alpha = 0.2) +
    geom_line(data = df2, aes(x = year, y = anet * coef + 100), col = "red") +
    scale_y_continuous(name = "EOS (DOY)",
                       sec.axis = sec_axis( ~(. - 100) / coef, name = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")))) +
    labs(x = "Year", 
         title = expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"), "      ", italic("A")[net], " ~ Year")), 
         subtitle = "PEP data and LPJ-GUESS") +
    theme_classic() +
    # annotation_custom(grobTree(t1)) +
    theme(axis.text.y.right = element_text(colour="red"),
          axis.ticks.y.right = element_line(colour="red"),
          axis.title.y.right = element_text(colour="red"),
          axis.text.y = element_text(colour="royalblue"),
          axis.ticks.y = element_line(colour="royalblue"),
          axis.title.y = element_text(colour="royalblue"),
          axis.line.y = element_line(colour = "royalblue"),
          axis.line.y.right = element_line(colour = "red"))
  
  return(gg)
}

gg_dual_zz <- ggplot_year_cAtot(x = out_plot_lt, y = out_plot_cAtot)
gg_dual_zz
```

### IAV vs. long-term vs. mean

This is based on a spatially stratified sampling.

#### Anet LPJ

Separate mean across years 1970-2000 from interannual anomaly.
```{r eval=FALSE}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_cA_tot = mean(cA_tot, na.rm = TRUE))
  df %>% 
    mutate(mean_cA_tot = df_mean$mean_cA_tot,
           anom_cA_tot = cA_tot - df_mean$mean_cA_tot)
}

df_anl_Zani <- df_anl_Zani %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)
```

Bootstrap 300 samples and test for significance in the mean Anet coefficient. This returns a data frame containing the coefficient estimate and the p-value for each sample.

```{r eval=FALSE}
get_pval_mean_anet <- function(use_seed, df){
  
  ## sample one time series per gridcell
  set.seed(use_seed)
  df_sites_sampled <- df %>% 
    dplyr::select(id_species_site, lon_mid, lat_mid) %>% 
    distinct() %>% 
    group_by(lon_mid, lat_mid) %>% 
    sample_n(1)
  df <- df %>% 
    dplyr::filter(id_species_site %in% df_sites_sampled$id_species_site)
  
  ## fit model separating mean Anet
  Fit_LT_anom = lmer(off ~ scale(mean_cA_tot) + scale(anom_cA_tot) + scale(year) + (1|id_site) + (1|species), data = df, na.action = "na.exclude")
  
  ## return p value for significance of term representing mean Anet
  out_sum <- summary(Fit_LT_anom)
  pval <- out_sum$coefficients["scale(mean_cA_tot)", "Pr(>|t|)"]
  esti <- out_sum$coefficients["scale(mean_cA_tot)", "Estimate"]
  
  return(tibble(estimate = esti, pval = pval))
}

n_samples <- 300
df_sampled_mean_anet <- purrr::map_dfr(as.list(seq(n_samples)), ~get_pval_mean_anet(., df_anl))

df_sampled_mean_anet %>% 
  ggplot(aes(estimate, ..count..)) +
  geom_histogram()

n_sign <- df_sampled_mean_anet %>% 
  dplyr::filter(pval < 0.05) %>% 
  nrow()

## fraction not significant
1 - n_sign/n_samples
```

## P-model data

### Interannual variation (IAV)

#### Anet P-model (Fig 1D)

```{r}
fit_iav_pm_gppnet = lmer(off ~ scale(gpp_net) + (1|id_site) + (1|species) , data = df_anl_pmodel, na.action = "na.exclude")
summary(fit_iav_pm_gppnet)
r.squaredGLMM(fit_iav_pm_gppnet)
plot(allEffects(fit_iav_pm_gppnet))

aic_iav_pm_gppnet <- AIC(fit_iav_pm_gppnet)
out_plot <- allEffects(fit_iav_pm_gppnet)
gg_iav_pm_gppnet <- ggplot_gpp_net(out_plot)
gg_iav_pm_gppnet
```

### Long-term (year)

#### Anet P-model (New Fig 1E and 1F)

```{r}
fit_lt_pm_gppnet = lmer(off ~ scale(gpp_net) + scale(year) + (1|id_site) + (1|species), data = df_anl_pmodel, na.action = "na.exclude")
summary(fit_lt_pm_gppnet)
r.squaredGLMM(fit_lt_pm_gppnet)
plot(allEffects(fit_lt_pm_gppnet))

aic_lt_pm_gppnet <- AIC(fit_lt_pm_gppnet)
out_plot_lt <- allEffects(fit_lt_pm_gppnet)
gg_lt_pm_gppnet <- ggplot_gpp_net(out_plot_lt)
gg_lt_pm_year <- ggplot_year(out_plot_lt)

gg_lt_pm_gppnet + gg_lt_pm_year
```

Is this better model than EOS ~ Anet?

```{r}
out_anova <- anova(fit_iav_pm_gppnet, fit_lt_pm_gppnet)
out_anova
```

#### Long-term trend in Anet.(New Fig 1F red)

```{r}
fit_anet_year <- lmer(gpp_net ~ scale(year) + (1|id_site) + (1|species), data = df_anl_pmodel, na.action = "na.exclude")
fit_anet_year <- lmer(gpp_net ~ year + (1|id_site) + (1|species), data = df_anl_pmodel, na.action = "na.exclude")
summary(fit_anet_year)
plot(allEffects(fit_anet_year))

out_plot_anet <- allEffects(fit_anet_year)
gg_lt_anet_year <- ggplot_year0(out_plot_anet)
gg_lt_anet_year <- gg_lt_anet_year + 
  labs(y = expression(italic("A")[net])) + 
  theme(plot.background = element_rect(fill = "grey80"))
gg_lt_anet_year

```

##### Plot dual figure

```{r}
ggplot_year_anet <- function(x, y){
  
  df1 <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1])
  df2 <- tibble(upper = y$`year`$upper[,1],
             lower = y$`year`$lower[,1],
             anet = y$`year`$fit[,1],
             year = y$`year`$x[,1])
  
  coef <- 0.7 * mean(df1$off) / mean(df2$anet)
  
  # library(grid)
  # t1 <- textGrob(expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"))), x = 0, y = 1.1, gp = gpar(col = "black"))
  
  gg <- ggplot() + 
    geom_ribbon(data = df1, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df1, aes(x = year, y = off), col = "royalblue") +
    
    geom_ribbon(data = df2, aes(x = year, ymin = lower * coef + 100, ymax = upper * coef + 100), alpha = 0.2) +
    geom_line(data = df2, aes(x = year, y = anet * coef + 100), col = "red") +
    scale_y_continuous(name = "EOS (DOY)",
                       sec.axis = sec_axis( ~(. - 100) / coef, name = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")))) +
    labs(x = "Year", 
         title = expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"), "      ", italic("A")[net], " ~ Year")), 
         subtitle = "Zani et al.") +
    theme_classic() +
    # annotation_custom(grobTree(t1)) +
    theme(axis.text.y.right = element_text(colour="red"),
          axis.ticks.y.right = element_line(colour="red"),
          axis.title.y.right = element_text(colour="red"),
          axis.text.y = element_text(colour="royalblue"),
          axis.ticks.y = element_line(colour="royalblue"),
          axis.title.y = element_text(colour="royalblue"),
          axis.line.y = element_line(colour = "royalblue"),
          axis.line.y.right = element_line(colour = "red"))
  
  return(gg)
}

gg_dual_zz <- ggplot_year_anet(x = out_plot_lt, y = out_plot_anet)
gg_dual_zz
```

## MODIS P-model data

### Interannual variation (IAV)

#### Start-of-Season (SOS)

```{r}
fit_iav_modis_on = lmer(off ~ scale(on) + (1|sitename) , data = df_anl_modis, na.action = "na.exclude")
summary(fit_iav_modis_on)
r.squaredGLMM(fit_iav_modis_on)
plot(allEffects(fit_iav_modis_on))

aic_iav_modis_on <- AIC(fit_iav_modis_on)
out_plot <- allEffects(fit_iav_modis_on)
gg_iav_modis_on <- ggplot_on(out_plot)
gg_iav_modis_on
```

#### Anet MODIS P-model (Fig 1D)

```{r}
fit_iav_modis_gppnet = lmer(off ~ scale(gpp_net) + (1|sitename) , data = df_anl_modis, na.action = "na.exclude")
summary(fit_iav_modis_gppnet)
r.squaredGLMM(fit_iav_modis_gppnet)
plot(allEffects(fit_iav_modis_gppnet))

aic_iav_modis_gppnet <- AIC(fit_iav_modis_gppnet)
out_plot <- allEffects(fit_iav_modis_gppnet)
gg_iav_modis_gppnet <- ggplot_gpp_net(out_plot)
gg_iav_modis_gppnet
```

### Long-term (year)

#### SOS

```{r}
fit_lt_modis_on = lmer(off ~ scale(on) + scale(year) + (1|sitename), data = df_anl_modis, na.action = "na.exclude")
summary(fit_lt_modis_on)
r.squaredGLMM(fit_lt_modis_on)
plot(allEffects(fit_lt_modis_on))

aic_lt_modis_on <- AIC(fit_lt_modis_on)
out_plot <- allEffects(fit_lt_modis_on)
gg_lt_modis_on <- ggplot_on(out_plot)
gg_lt_modis_year <- ggplot_year(out_plot)

gg_lt_modis_on + gg_lt_modis_year
```

Long-term trend in SOS.

```{r}
fit_on_year <- lmer(on ~ scale(year) + (1|sitename), data = df_anl_modis, na.action = "na.exclude")
summary(fit_on_year)
r.squaredGLMM(fit_on_year)
plot(allEffects(fit_on_year))

out_plot <- allEffects(fit_on_year)
gg_modis_on_year <- ggplot_year(out_plot)
gg_modis_on_year <- gg_modis_on_year + ylab("SOS (DOY)") 
gg_modis_on_year
```

#### Anet P-model

```{r}
fit_lt_modis_gppnet = lmer(off ~ scale(gpp_net) + scale(year) + (1|sitename), data = df_anl_modis, na.action = "na.exclude")
summary(fit_lt_modis_gppnet)
r.squaredGLMM(fit_lt_modis_gppnet)
plot(allEffects(fit_lt_modis_gppnet))

aic_lt_modis_gppnet <- AIC(fit_lt_modis_gppnet)
out_plot_lt <- allEffects(fit_lt_modis_gppnet)
gg_lt_modis_gppnet <- ggplot_gpp_net(out_plot_lt)
gg_lt_modis_year <- ggplot_year(out_plot_lt)

gg_lt_modis_gppnet + gg_lt_modis_year

```

Is this better model than EOS ~ Anet?

```{r}
out_anova <- anova(fit_iav_modis_gppnet, fit_lt_modis_gppnet)
out_anova
```

#### Long-term trend in Anet.(New Fig 1C red, old Fig 1D red)

```{r}
fit_anet_year <- lmer(gpp_net ~ scale(year) + (1|sitename), data = df_anl_modis, na.action = "na.exclude")
summary(fit_anet_year)
plot(allEffects(fit_anet_year))

out_plot_anet <- allEffects(fit_anet_year)
gg_lt_anet_year <- ggplot_year(out_plot_anet)
gg_lt_anet_year <- gg_lt_anet_year + 
  labs(y = expression(italic("A")[net]))
gg_lt_anet_year
```

##### Plot dual figure

```{r}
ggplot_year_anet <- function(x, y){
  
  df1 <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1])
  df2 <- tibble(upper = y$`scale(year)`$upper[,1],
             lower = y$`scale(year)`$lower[,1],
             anet = y$`scale(year)`$fit[,1],
             year = y$`scale(year)`$x[,1])
  
  coef <- 0.7 * mean(df1$off) / mean(df2$anet)
  
  # library(grid)
  # t1 <- textGrob(expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"))), x = 0, y = 1.1, gp = gpar(col = "black"))
  
  gg <- ggplot() + 
    geom_ribbon(data = df1, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df1, aes(x = year, y = off), col = "royalblue") +
    
    geom_ribbon(data = df2, aes(x = year, ymin = lower * coef + 100, ymax = upper * coef + 100), alpha = 0.2) +
    geom_line(data = df2, aes(x = year, y = anet * coef + 100), col = "red") +
    scale_y_continuous(name = "EOS (DOY)",
                       sec.axis = sec_axis( ~(. - 100) / coef, name = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")))) +
    labs(x = "Year", 
         title = expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"), "      ", italic("A")[net], " ~ Year")), 
         subtitle = "MODIS data and P-model") +
    theme_classic() +
    # annotation_custom(grobTree(t1)) +
    theme(axis.text.y.right = element_text(colour="red"),
          axis.ticks.y.right = element_line(colour="red"),
          axis.title.y.right = element_text(colour="red"),
          axis.text.y = element_text(colour="royalblue"),
          axis.ticks.y = element_line(colour="royalblue"),
          axis.title.y = element_text(colour="royalblue"),
          axis.line.y = element_line(colour = "royalblue"),
          axis.line.y.right = element_line(colour = "red"))
  
  return(gg)
}

gg_dual_modis <- ggplot_year_anet(x = out_plot_lt, y = out_plot_anet)
gg_dual_modis
```

### IAV vs. long-term vs. mean

This is based on a spatially stratified sampling.

#### Anet MODIS P-model

Separate mean across years 2001-2018 from interannual anomaly.

```{r eval=FALSE}
separate_anom <- function(df){
  df_mean <- df %>% 
    #dplyr::filter(year %in% 2001:2018) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_gpp_net = mean(gpp_net, na.rm = TRUE))
  df %>% 
    mutate(mean_gpp_net = df_mean$mean_gpp_net,
           anom_gpp_net = gpp_net - df_mean$mean_gpp_net)
}

df_anl_modis <- df_anl_modis %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## gpp_net
fit_lt_modis_anom = lmer(off ~ scale(mean_gpp_net) + scale(anom_gpp_net) + scale(year) + (1|sitename), data = df_anl_modis, na.action = "na.exclude")
summary(fit_lt_modis_anom)
plot(allEffects(fit_lt_modis_anom))
r.squaredGLMM(fit_lt_modis_anom)

aic_lt_modis_anom <- AIC(fit_lt_modis_anom)
out_plot_lt <- allEffects(fit_lt_modis_anom)
gg_lt_modis_mean <- ggplot_mean_gpp_net(out_plot_lt)
gg_lt_modis_anom <- ggplot_anom_gpp_net(out_plot_lt)
gg_lt_modis_year <- ggplot_year(out_plot_lt)

gg_lt_modis_mean + gg_lt_modis_anom + gg_lt_modis_year

```

Bootstrap 300 samples and test for significance in the mean Anet coefficient. This returns a data frame containing the coefficient estimate and the p-value for each sample.

```{r eval=FALSE}
get_pval_mean_anet <- function(use_seed, df){
  
  ## sample one time series per gridcell
  set.seed(use_seed)
  df_sites_sampled <- df %>% 
    dplyr::select(sitename, lon, lat) %>% 
    distinct() %>% 
    group_by(lon, lat) %>% 
    sample_n(1)
  df <- df %>% 
    dplyr::filter(sitename %in% df_sites_sampled$sitename)
  
  ## fit model separating mean Anet
  Fit_LT_anom = lmer(off ~ scale(mean_gpp_net) + scale(anom_gpp_net) + scale(year) + (1|sitename), data = df, na.action = "na.exclude")
  
  ## return p value for significance of term representing mean Anet
  out_sum <- summary(Fit_LT_anom)
  pval <- out_sum$coefficients["scale(mean_gpp_net)", "Pr(>|t|)"]
  esti <- out_sum$coefficients["scale(mean_gpp_net)", "Estimate"]
  
  return(tibble(estimate = esti, pval = pval))
}

n_samples <- 300
df_sampled_mean_anet <- purrr::map_dfr(as.list(seq(n_samples)), ~get_pval_mean_anet(., df_anl_modis))

df_sampled_mean_anet %>% 
  ggplot(aes(estimate, ..count..)) +
  geom_histogram()

n_sign <- df_sampled_mean_anet %>% 
  dplyr::filter(pval < 0.05) %>% 
  nrow()

## fraction not significant
1 - n_sign/n_samples
```

## Figure 1

```{r}
gg_iav_zz_cAtot <- gg_iav_zz_cAtot +
  labs(title = expression(paste("EOS ~ ", italic("A")[net])), subtitle = "PEP data and LPJ-GUESS")

gg_lt_zz_cAtot <- gg_lt_zz_cAtot +
  labs(title = expression(paste("EOS ~ ", bolditalic("A")[bold(net)], " + Year")), subtitle = "PEP data and LPJ-GUESS")

gg_lt_zz_year <- gg_lt_zz_year +
  labs(title = expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"))), subtitle = "PEP data and LPJ-GUESS")

pp <- (gg_iav_zz_cAtot + gg_lt_zz_cAtot + gg_lt_zz_year)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/fig_1_zz.png", width = 11, height = 4)

# With p-model outputs
pp <- (gg_iav_zz_cAtot + gg_lt_zz_cAtot + gg_lt_zz_year)/(gg_iav_pm_cAtot + gg_lt_pm_gppnet + gg_lt_pm_year)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/fig_1_zz.png", width = 11, height = 4)

# With dual plot
pp <- (gg_iav_zz_cAtot + gg_lt_zz_anet + gg_dual_zz)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/fig_1_wrapup_zz.png", width = 12, height = 4)

pp <- (gg_iav_zz_cAtot + gg_lt_zz_anet + gg_dual_zz) /
  (gg_iav_pm + gg_lt_pm_anet + gg_dual_pm)
pp + plot_annotation(
  title = expression(paste("EOS ~ SOS")),
  tag_levels = 'A'
)
ggsave("~/pep/fig_1.png", width = 12, height = 4)

```

Fig. 1 (A) Relationship of end-of-season (EOS, expressed as day-of-year, DOY) versus Anet simulated by Zani et al., based on a linear mixed-effects regression (LMER) model with scaled Anet as a fixed effect and site and species as grouping variables of random intercepts. (B) Temporal trend of Anet, based on a LMER model with year as a fixed effect and site and species as grouping variables of the random intercept. (C, D) Partial relationships of a multiple LMER model, where the long-term trend (year) and Anet are treated as fixed effects (effects shown here), and site and species are treated as grouping variables of the random intercepts. The trend towards later EOS (D) exists in parallel with the trend towards higher Anet (B).

## Supplementary Fig. 1

```{r}
gg_iav_zz_on <- gg_iav_zz_on +
  labs(title = "EOS ~ SOS", subtitle = "PEP data and LPG-GUESS")

gg_zz_on_year <- gg_zz_on_year +
  labs(title = "SOS ~ Year", subtitle = "PEP data and LPG-GUESS")

gg_lt_cAtot_year <- gg_lt_cAtot_year +
  labs(title = expression(paste(italic("A")[net], " ~ Year")), subtitle = "PEP data and LPG-GUESS")

pp <- (gg_iav_zz_on + gg_zz_on_year + gg_lt_cAtot_year)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/Sup_fig_1_zz.png", width = 11, height = 4)

```

## Figure 2

```{r}
gg_iav_modis_gppnet <- gg_iav_modis_gppnet +
  labs(title = expression(paste("EOS ~ ", italic("A")[net])), subtitle = "MODIS data and P-model")

gg_lt_modis_gppnet <- gg_lt_modis_gppnet +
  labs(title = expression(paste("EOS ~ ", bolditalic("A")[bold(net)], " + Year")), subtitle = "MODIS data and P-model")

gg_lt_modis_year <- gg_lt_modis_year +
  labs(title = expression(paste("EOS ~ ", italic("A")[net], " + ", bold("Year"))), subtitle = "MODIS data and P-model")

pp <- (gg_iav_modis_gppnet + gg_lt_modis_gppnet + gg_lt_modis_year)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/fig_2_modis.png", width = 11, height = 4)

# With p-model outputs
pp <- (gg_iav_zz_cAtot + gg_lt_zz_cAtot + gg_lt_zz_year)/(gg_iav_pm_cAtot + gg_lt_pm_gppnet + gg_lt_pm_year)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/fig_1_zz.png", width = 11, height = 4)

# With dual plot
pp <- (gg_iav_zz_cAtot + gg_lt_zz_anet + gg_dual_zz)
pp + plot_annotation(tag_levels = 'A')
ggsave("~/pep/fig_1_wrapup_zz.png", width = 12, height = 4)

pp <- (gg_iav_zz_cAtot + gg_lt_zz_anet + gg_dual_zz) /
  (gg_iav_pm + gg_lt_pm_anet + gg_dual_pm)
pp + plot_annotation(
  title = expression(paste("EOS ~ SOS")),
  tag_levels = 'A'
)
ggsave("~/pep/fig_1.png", width = 12, height = 4)

```
