---
title: "Analysis for the phenology paper"
author: "Laura Marques"
date: "8/17/2021"
output: html_document
---

## Load packages
```{r setup}
library(tidyverse)
library(lubridate)
library(broom)
library(devtools)
library(dplyr)
#devtools::install_github("stineb/rbeni")
#devtools::load_all("~/rbeni/")
#library(rbeni)
library(lme4) #lmer
library(MuMIn) #r.squaredGLMM
library(lmerTest) #p-values
library(effects) #plot effects
library(sjPlot) #plot effects
library(patchwork)
library(maps)
library(viridis)
library(rgdal)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
library(gridExtra)
library(cowplot)
```

## Load functions

```{r}
ggplot_on <- function(x){
  df <- tibble(upper = x$`scale(on)`$upper[,1],
               lower = x$`scale(on)`$lower[,1],
               off = x$`scale(on)`$fit[,1],
               on = x$`scale(on)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = on, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(on, off), col = "royalblue") +
    theme_classic() +
    labs(x = "SOS (DOY)", y = "EOS (DOY)")
  return(gg)
}

ggplot_year <- function(x){
  df <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(year, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Year", y = "EOS (DOY)")
  return(gg)
}

ggplot_cA_tot <- function(x){
  df <- tibble(upper = x$`scale(cA_tot)`$upper[,1],
               lower = x$`scale(cA_tot)`$lower[,1],
               off = x$`scale(cA_tot)`$fit[,1],
               cA_tot = x$`scale(cA_tot)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = cA_tot, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(cA_tot, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

ggplot_gpp_net <- function(x){
  df <- tibble(upper = x$`scale(gpp_net)`$upper[,1],
               lower = x$`scale(gpp_net)`$lower[,1],
               off   = x$`scale(gpp_net)`$fit[,1],
               gpp_net = x$`scale(gpp_net)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = gpp_net, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(gpp_net, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

ggplot_year_anet <- function(x, y){
  df <- tibble(upper = x$`scale(year)`$upper[,1],
               lower = x$`scale(year)`$lower[,1],
               off = x$`scale(year)`$fit[,1],
               year = x$`scale(year)`$x[,1]) %>% 
    bind_rows(
      tibble(upper = y$`scale(year)`$upper[,1],
             lower = y$`scale(year)`$lower[,1],
             anet   = y$`scale(year)`$fit[,1],
             year = y$`scale(year)`$x[,1])
    )
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(year, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Year", y = "EOS (DOY)")
  return(gg)
}

ggplot_mean_cA_tot <- function(x){
  df <- tibble(upper = x$`scale(mean_cA_tot)`$upper[,1],
               lower = x$`scale(mean_cA_tot)`$lower[,1],
               off = x$`scale(mean_cA_tot)`$fit[,1],
               mean_cA_tot = x$`scale(mean_cA_tot)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = mean_cA_tot, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(mean_cA_tot, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste("Mean " ,italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  return(gg)
}

ggplot_anom_cA_tot <- function(x){
  df <- tibble(upper = x$`scale(anom_cA_tot)`$upper[,1],
               lower = x$`scale(anom_cA_tot)`$lower[,1],
               off   = x$`scale(anom_cA_tot)`$fit[,1],
               anom_cA_tot = x$`scale(anom_cA_tot)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = anom_cA_tot, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(anom_cA_tot, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste("Anomalies " ,italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

ggplot_mean_gpp_net <- function(x){
  df <- tibble(upper = x$`scale(mean_gpp_net)`$upper[,1],
               lower = x$`scale(mean_gpp_net)`$lower[,1],
               off = x$`scale(mean_gpp_net)`$fit[,1],
               mean_gpp_net = x$`scale(mean_gpp_net)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = mean_gpp_net, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(mean_gpp_net, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste("Mean " ,italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  return(gg)
}

ggplot_anom_gpp_net <- function(x){
  df <- tibble(upper = x$`scale(anom_gpp_net)`$upper[,1],
               lower = x$`scale(anom_gpp_net)`$lower[,1],
               off   = x$`scale(anom_gpp_net)`$fit[,1],
               anom_gpp_net = x$`scale(anom_gpp_net)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = anom_gpp_net, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(anom_gpp_net, off), col = "royalblue") +
    theme_classic() +
    labs(x = expression(paste("Anomalies " ,italic("A")[net], " (gC m"^-2, " yr"^-1, ")")), y = "EOS (DOY)")
  
  return(gg)
}

ggplot_mean_on <- function(x){
  df <- tibble(upper = x$`scale(mean_on)`$upper[,1],
               lower = x$`scale(mean_on)`$lower[,1],
               off = x$`scale(mean_on)`$fit[,1],
               mean_on = x$`scale(mean_on)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = mean_on, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(mean_on, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Mean SOS (DOY)", y = "EOS (DOY)")
  return(gg)
}

ggplot_anom_on <- function(x){
  df <- tibble(upper = x$`scale(anom_on)`$upper[,1],
               lower = x$`scale(anom_on)`$lower[,1],
               off   = x$`scale(anom_on)`$fit[,1],
               anom_on = x$`scale(anom_on)`$x[,1])
  gg <- ggplot() + 
    geom_ribbon(data = df, aes(x = anom_on, ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line(data = df, aes(anom_on, off), col = "royalblue") +
    theme_classic() +
    labs(x = "Anomalies SOS (DOY)", y = "EOS (DOY)")
  
  return(gg)
}
```

## Load data

### Zani et al. PEP data

Data from PEP pheno and LPJ-GUESS photosynthesis

Read the data complemented with drivers, obtained from Constantin Zohner (7.12.2020).
```{r}
df_zz <- data.table::fread("~/data/pep/processed/DataMeta_3_Drivers_20_11_10.csv") %>% 
  as_tibble() %>% 
  rename(lon = LON, lat = LAT, year = YEAR, off = DoY_off, on = DoY_out, 
         anom_off_zani = autumn_anomaly, anom_on_zani = spring_anomaly, 
         species = Species, id_site = PEP_ID, id_species_site = timeseries)
min(pep725_pmodel$year)
```

### P-model outputs data

New simulations with daylight < 12h instead of 11h. or considering the cutoff in 21-Jun
```{r}
# Read p-model outputs
pep725_pmodel <- readRDS("~/pep/data/pmodel_output/pep725_pmodel_output_21J.rds")
pep725_pmodel <- pep725_pmodel %>% 
  mutate(gpp_net = gpp - rd, 
         lue = gpp / apar)
# Join datasets
# PEP data provided by ZZ
df_zz <- df_zz %>% rename(sitename=id_species_site)
df_zz_pmodel <- df_zz %>% 
  left_join(pep725_pmodel)
```

### MODIS P-model outputs

Data from MODIS pheno and P-model photosynthesis
New simulations with daylight < 12h instead of 11h. or considering the cutoff in 21-Jun
```{r}
# Read phenology dates from MODIS
modis_pheno_sites <- readRDS("~/pep/data/modis_phenology/modis_pheno_sites.rds")
# Read p-model outputs
modis_pmodel <- readRDS("~/pep/data/pmodel_output/modis_pmodel_output_21J.rds")
modis_pmodel <- modis_pmodel %>% 
  mutate(gpp_net = gpp - rd, 
         lue = gpp / apar)
# Join datasets
df_modis <- modis_pheno_sites %>% 
  left_join(modis_pmodel[,2:10], by = c("lon","lat","year"))

# Change variable names
df_modis <- df_modis %>% rename(on = SOS_2_doy, off = EOS_2_doy) # Select the pheno band
df_modis <- df_modis %>% filter(off>on)
max(df_modis$year)
```

## Zani et al. data

### Interannual variation (IAV)

#### Start-of-Season (SOS) - Fig 2C

```{r}
fit_iav_pep_off_vs_on = lmer(off ~ scale(on) + (1|id_site) + (1|species) , data = df_zz, na.action = "na.exclude")
summary(fit_iav_pep_off_vs_on)
r.squaredGLMM(fit_iav_pep_off_vs_on)
plot(allEffects(fit_iav_pep_off_vs_on))

aic_iav_pep_off_vs_on <- AIC(fit_iav_pep_off_vs_on)
out_iav_pep_off_vs_on <- allEffects(fit_iav_pep_off_vs_on)
gg_iav_pep_off_vs_on <- ggplot_on(out_iav_pep_off_vs_on)
gg_iav_pep_off_vs_on
```

#### Anet LPJ - Fig 1C

```{r}
fit_iav_pep_off_vs_cAtot = lmer(off ~ scale(cA_tot) + (1|id_site) + (1|species) , data = df_zz, na.action = "na.exclude")
summary(fit_iav_pep_off_vs_cAtot)
r.squaredGLMM(fit_iav_pep_off_vs_cAtot)
plot(allEffects(fit_iav_pep_off_vs_cAtot))

aic_iav_pep_off_vs_cAtot <- AIC(fit_iav_pep_off_vs_cAtot)
out_iav_pep_off_vs_cAtot <- allEffects(fit_iav_pep_off_vs_cAtot)
gg_iav_pep_off_vs_cAtot <- ggplot_cA_tot(out_iav_pep_off_vs_cAtot)
gg_iav_pep_off_vs_cAtot
```

### Long-term (year)

#### EOS - Fig 2B and 2C

```{r}
fit_lt_pep_off_vs_on_year = lmer(off ~ scale(on) + scale(year) + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
summary(fit_lt_pep_off_vs_on_year)
r.squaredGLMM(fit_lt_pep_off_vs_on_year)
plot(allEffects(fit_lt_pep_off_vs_on_year))

aic_lt_pep_off_vs_on_year <- AIC(fit_lt_pep_off_vs_on_year)
out_lt_pep_off_vs_on_year <- allEffects(fit_lt_pep_off_vs_on_year)
gg_lt_pep_off_vs_on   <- ggplot_on(out_lt_pep_off_vs_on_year)
gg_lt_pep_off_vs_year1 <- ggplot_year(out_lt_pep_off_vs_on_year)

gg_lt_pep_off_vs_on + gg_lt_pep_off_vs_year1
```

Is this better model than EOS ~ SOS?

```{r}
out_anova <- anova(fit_iav_pep_off_vs_on, fit_lt_pep_off_vs_on_year)
out_anova
```

#### SOS - Fig 2

```{r}
fit_lt_pep_on_vs_year <- lmer(on ~ scale(year) + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
summary(fit_lt_pep_on_vs_year)
sd(df_zz$year)

fit_lt_pep_on_vs_year_Nostd <- lmer(on ~ year + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
summary(fit_lt_pep_on_vs_year_Nostd)

plot(allEffects(fit_lt_pep_on_vs_year))
plot(allEffects(fit_lt_pep_on_vs_year_Nostd))

out_lt_pep_on_vs_year <- allEffects(fit_lt_pep_on_vs_year)
gg_lt_pep_on_vs_year <- ggplot_year(out_lt_pep_on_vs_year)
gg_lt_pep_on_vs_year <- gg_lt_pep_on_vs_year + ylab("SOS (DOY)") 
gg_lt_pep_on_vs_year
```

#### SOS - Fig 2D

```{r}
fit_lt_pep_on_vs_year <- lmer(on ~ scale(year) + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
out <- summary(fit_lt_pep_on_vs_year)
print(out)
upperCI <- out$coefficients["scale(year)","Estimate"] + out$coefficient["scale(year)","Std. Error"]*1.96
lowerCI <- out$coefficients["scale(year)","Estimate"] - out$coefficient["scale(year)","Std. Error"]*1.96
# Unscaled
trend_unscaled <- out$coefficients["scale(year)","Estimate"]/ sd(df_zz$year)
error_unscaled <- out$coefficients["scale(year)","Std. Error"]/ sd(df_zz$year)
upperCI_unscaled <- out$coefficients["scale(year)","Estimate"]/ sd(df_zz$year) + out$coefficient["scale(year)","Std. Error"]/ sd(df_zz$year)*1.96
lowerCI_unscaled <- out$coefficients["scale(year)","Estimate"]/ sd(df_zz$year) - out$coefficient["scale(year)","Std. Error"]/ sd(df_zz$year)*1.96
print(paste("Temporal trend: ", round(trend_unscaled, digits = 3), "+/-", round(error_unscaled, digits = 3), "d/yr"))
confint(fit_lt_pep_on_vs_year)
out_lt_pep_on_vs_year <- allEffects(fit_lt_pep_on_vs_year)
gg_lt_pep_on_vs_year <- ggplot_year(out_lt_pep_on_vs_year)
gg_lt_pep_on_vs_year <- gg_lt_pep_on_vs_year + ylab("SOS (DOY)") 
gg_lt_pep_on_vs_year

# Univariate model without scaling predictor
fit_lt_pep_on_vs_yearNS <- lmer(on ~ year + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
out_ns <- summary(fit_lt_pep_on_vs_yearNS)
print(out_ns)
upperCI <- out_ns$coefficients["year","Estimate"] + out_ns$coefficient["year","Std. Error"]*1.96
lowerCI <- out_ns$coefficients["year","Estimate"] - out_ns$coefficient["year","Std. Error"]*1.96
```

Univariate relationship for EOS trend.
```{r}
fit_lt_pep_off_vs_year <- lmer(off ~ scale(year) + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
out <- summary(fit_lt_pep_off_vs_year)
print(out)
trend_unscaled <- out$coefficients["scale(year)","Estimate"]/ sd(df_zz$year)
error_unscaled <- out$coefficients["scale(year)","Std. Error"]/ sd(df_zz$year)
print(paste("Temporal trend: ", round(trend_unscaled, digits = 3), "+/-", round(error_unscaled, digits = 3), "d/yr"))
out_lt_pep_off_vs_year <- allEffects(fit_lt_pep_off_vs_year)
gg_lt_pep_off_vs_year <- ggplot_year(out_lt_pep_off_vs_year)
gg_lt_pep_off_vs_year <- gg_lt_pep_off_vs_year + ylab("EOS (DOY)") 
gg_lt_pep_off_vs_year

# Univariate model without scaling predictor
fit_lt_pep_off_vs_yearNS <- lmer(off ~ year + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
out_ns <- summary(fit_lt_pep_off_vs_yearNS)
print(out_ns)
upperCI <- out_ns$coefficients["year","Estimate"] + out_ns$coefficient["year","Std. Error"]*1.96
lowerCI <- out_ns$coefficients["year","Estimate"] - out_ns$coefficient["year","Std. Error"]*1.96
```

#### Anet LPJ - Fig 1B and 1C 

```{r}
fit_lt_pep_off_vs_cAtot_year = lmer(off ~ scale(cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
summary(fit_lt_pep_off_vs_cAtot_year)
r.squaredGLMM(fit_lt_pep_off_vs_cAtot_year)
plot(allEffects(fit_lt_pep_off_vs_cAtot_year))

aic_lt_pep_off_vs_cAtot_year <- AIC(fit_lt_pep_off_vs_cAtot_year)
out_lt_pep_off_vs_cAtot_year <- allEffects(fit_lt_pep_off_vs_cAtot_year)
gg_lt_pep_off_vs_cAtot <- ggplot_cA_tot(out_lt_pep_off_vs_cAtot_year)
gg_lt_pep_off_vs_year2 <- ggplot_year(out_lt_pep_off_vs_cAtot_year)

gg_lt_pep_off_vs_cAtot + gg_lt_pep_off_vs_year2
```

Is this better model than EOS ~ Anet?

```{r}
out_anova <- anova(fit_iav_pep_off_vs_cAtot, fit_lt_pep_off_vs_cAtot_year)
out_anova
```

#### Long-term trend in Anet - Fig 2E

```{r}
fit_lt_pep_cAtot_vs_year <- lmer(cA_tot ~ scale(year) + (1|id_site) + (1|species), data = df_zz, na.action = "na.exclude")
summary(fit_lt_pep_cAtot_vs_year)
plot(allEffects(fit_lt_pep_cAtot_vs_year))

out_lt_pep_cAtot_vs_year <- allEffects(fit_lt_pep_cAtot_vs_year)
gg_lt_pep_cAtot_vs_year <- ggplot_year(out_lt_pep_cAtot_vs_year)
gg_lt_pep_cAtot_vs_year <- gg_lt_pep_cAtot_vs_year + 
  labs(y = expression(italic("A")[net]))
gg_lt_pep_cAtot_vs_year
```

## P-model data

### Interannual variation (IAV)

#### Anet P-model - Fig 1D

```{r}
fit_iav_pep_off_vs_gppnet = lmer(off ~ scale(gpp_net) + (1|id_site) + (1|species), data = df_zz_pmodel, na.action = "na.exclude")
summary(fit_iav_pep_off_vs_gppnet)
r.squaredGLMM(fit_iav_pep_off_vs_gppnet)
plot(allEffects(fit_iav_pep_off_vs_gppnet))

aic_iav_pep_off_vs_gppnet <- AIC(fit_iav_pep_off_vs_gppnet)
out_pep_off_vs_gppnet <- allEffects(fit_iav_pep_off_vs_gppnet)
gg_iav_pep_off_vs_gppnet <- ggplot_gpp_net(out_pep_off_vs_gppnet)
gg_iav_pep_off_vs_gppnet
```

### Long-term (year)

#### Anet P-model - Fig 1E and 1F

```{r}
fit_lt_pep_off_vs_gppnet_year = lmer(off ~ scale(gpp_net) + scale(year) + (1|id_site) + (1|species), data = df_zz_pmodel, na.action = "na.exclude")
summary(fit_lt_pep_off_vs_gppnet_year)
r.squaredGLMM(fit_lt_pep_off_vs_gppnet_year)
plot(allEffects(fit_lt_pep_off_vs_gppnet_year))

aic_lt_pep_off_vs_gppnet_year <- AIC(fit_lt_pep_off_vs_gppnet_year)
out_pep_off_vs_gppnet_year <- allEffects(fit_lt_pep_off_vs_gppnet_year)
gg_lt_pep_off_vs_gppnet <- ggplot_gpp_net(out_pep_off_vs_gppnet_year)
gg_lt_pep_off_vs_year3 <- ggplot_year(out_pep_off_vs_gppnet_year)

gg_lt_pep_off_vs_gppnet + gg_lt_pep_off_vs_year3
```

Is this better model than EOS ~ Anet?

```{r}
out_anova <- anova(fit_iav_pep_off_vs_gppnet, fit_lt_pep_off_vs_gppnet_year)
out_anova
```

#### Long-term trend in Anet - Fig. 2F

```{r}
fit_lt_pep_gppnet_vs_year <- lmer(gpp_net ~ scale(year) + (1|id_site) + (1|species), data = df_zz_pmodel, na.action = "na.exclude")
summary(fit_lt_pep_gppnet_vs_year)
plot(allEffects(fit_lt_pep_gppnet_vs_year))

out_lt_pep_gppnet_vs_year <- allEffects(fit_lt_pep_gppnet_vs_year)
gg_lt_pep_gppnet_vs_year <- ggplot_year(out_lt_pep_gppnet_vs_year)
gg_lt_pep_gppnet_vs_year <- gg_lt_pep_gppnet_vs_year + labs(y = expression(italic("A")[net])) 
gg_lt_pep_gppnet_vs_year

```

## MODIS P-model data

### Interannual variation (IAV)

#### Start-of-Season (SOS) - Fig 3A

```{r}
fit_iav_modis_off_vs_on = lmer(off ~ scale(on) + (1|sitename) , data = df_modis, na.action = "na.exclude")
summary(fit_iav_modis_off_vs_on)
r.squaredGLMM(fit_iav_modis_off_vs_on)
plot(allEffects(fit_iav_modis_off_vs_on))

aic_iav_modis_off_vs_on <- AIC(fit_iav_modis_off_vs_on)
out_iav_modis_off_vs_on <- allEffects(fit_iav_modis_off_vs_on)
gg_iav_modis_off_vs_on <- ggplot_on(out_iav_modis_off_vs_on)
gg_iav_modis_off_vs_on
```

#### Anet MODIS P-model

```{r}
fit_iav_modis_off_vs_gppnet = lmer(off ~ scale(gpp_net) + (1|sitename) , data = df_modis, na.action = "na.exclude")
summary(fit_iav_modis_off_vs_gppnet)
r.squaredGLMM(fit_iav_modis_off_vs_gppnet)
plot(allEffects(fit_iav_modis_off_vs_gppnet))

aic_iav_modis_off_vs_gppnet <- AIC(fit_iav_modis_off_vs_gppnet)
out_iav_modis_off_vs_gppnet <- allEffects(fit_iav_modis_off_vs_gppnet)
gg_iav_modis_off_vs_gppnet <- ggplot_gpp_net(out_iav_modis_off_vs_gppnet)
gg_iav_modis_off_vs_gppnet
```

### Long-term (year)

#### EOS - Fig 3B and 3C

```{r}
fit_lt_modis_off_vs_on_year = lmer(off ~ scale(on) + scale(year) + (1|sitename), data = df_modis, na.action = "na.exclude")
summary(fit_lt_modis_off_vs_on_year)
r.squaredGLMM(fit_lt_modis_off_vs_on_year)
plot(allEffects(fit_lt_modis_off_vs_on_year))
AIC(fit_iav_modis_off_vs_on,fit_lt_modis_off_vs_on_year)

aic_lt_modis_off_vs_on_year <- AIC(fit_lt_modis_off_vs_on_year)
out_lt_modis_off_vs_on_year <- allEffects(fit_lt_modis_off_vs_on_year)
gg_lt_modis_off_vs_on <- ggplot_on(out_lt_modis_off_vs_on_year)
gg_lt_modis_off_vs_year1 <- ggplot_year(out_lt_modis_off_vs_on_year)

gg_lt_modis_off_vs_on + gg_lt_modis_off_vs_year1
```

#### EOS - Fig 3D

```{r}
fit_lt_modis_on_vs_year <- lmer(on ~ scale(year) + (1|sitename), data = df_modis, na.action = "na.exclude")
summary(fit_lt_modis_on_vs_year)
r.squaredGLMM(fit_lt_modis_on_vs_year)
plot(allEffects(fit_lt_modis_on_vs_year))

out_lt_modis_on_vs_year <- allEffects(fit_lt_modis_on_vs_year)
gg_lt_modis_on_vs_year <- ggplot_year(out_lt_modis_on_vs_year)
gg_lt_modis_on_vs_year <- gg_lt_modis_on_vs_year + ylab("SOS (DOY)") 
gg_lt_modis_on_vs_year
```

#### Anet P-model

```{r}
fit_lt_modis_off_vs_gppnet_year = lmer(off ~ scale(gpp_net) + scale(year) + (1|sitename), data = df_modis, na.action = "na.exclude")
summary(fit_lt_modis_off_vs_gppnet_year)
r.squaredGLMM(fit_lt_modis_off_vs_gppnet_year)
plot(allEffects(fit_lt_modis_off_vs_gppnet_year))

aic_lt_modis_off_vs_gppnet_year <- AIC(fit_lt_modis_off_vs_gppnet_year)
out_lt_modis_off_vs_gppnet_year <- allEffects(fit_lt_modis_off_vs_gppnet_year)
gg_lt_modis_off_vs_gppnet <- ggplot_gpp_net(out_lt_modis_off_vs_gppnet_year)
gg_lt_modis_off_vs_year2 <- ggplot_year(out_lt_modis_off_vs_gppnet_year)

gg_lt_modis_off_vs_gppnet + gg_lt_modis_off_vs_year2

```

Is this better model than EOS ~ Anet?

```{r}
out_anova <- anova(fit_iav_modis_off_vs_gppnet, fit_lt_modis_off_vs_gppnet_year)
out_anova
```

#### Long-term trend in Anet -  

```{r}
fit_lt_modis_gppnet_vs_year <- lmer(gpp_net ~ scale(year) + (1|sitename), data = df_modis, na.action = "na.exclude")
summary(fit_lt_modis_gppnet_vs_year)
plot(allEffects(fit_lt_modis_gppnet_vs_year))

out_lt_modis_gppnet_vs_year <- allEffects(fit_lt_modis_gppnet_vs_year)
gg_lt_modis_gppnet_vs_year <- ggplot_year(out_lt_modis_gppnet_vs_year)
gg_lt_modis_gppnet_vs_year <- gg_lt_modis_gppnet_vs_year + labs(y = expression(italic("A")[net]))
gg_lt_modis_gppnet_vs_year
```

### IAV vs. long-term vs. mean

This is based on a spatially stratified sampling.

#### Anet MODIS P-model - Figure 2A and 2B

Separate mean across years 2001-2018 from interannual anomaly.

```{r eval=FALSE}
separate_anom <- function(df){
  df_mean <- df %>% 
    #dplyr::filter(year %in% 2001:2018) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_gpp_net = mean(gpp_net, na.rm = TRUE))
  df %>% 
    mutate(mean_gpp_net = df_mean$mean_gpp_net,
           anom_gpp_net = gpp_net - df_mean$mean_gpp_net)
}

df_modis <- df_modis %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(data = purrr::map(data, ~separate_anom(.))) %>% 
  unnest(data)

fit_modis_anom_gppnet = lmer(off ~ scale(mean_gpp_net) + scale(anom_gpp_net) + (1|sitename) + (1|year), data = df_modis, na.action = "na.exclude")
summary(fit_modis_anom_gppnet)
plot(allEffects(fit_modis_anom_gppnet))
r.squaredGLMM(fit_modis_anom_gppnet)

aic_modis_anom_gppnet <- AIC(fit_modis_anom_gppnet)
out_modis_anom_gppnet <- allEffects(fit_modis_anom_gppnet)
gg_modis_mean_gppnet <- ggplot_mean_gpp_net(out_modis_anom_gppnet)
gg_modis_anom_gppnet <- ggplot_anom_gpp_net(out_modis_anom_gppnet)

gg_modis_mean_gppnet + gg_modis_anom_gppnet

```

#### SOS 

Separate mean across years 2001-2018 from interannual anomaly.

```{r eval=FALSE}
separate_anom <- function(df){
  df_mean <- df %>% 
    #dplyr::filter(year %in% 2001:2018) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_on = mean(on, na.rm = TRUE))
  df %>% 
    mutate(mean_on = df_mean$mean_on,
           anom_on = on - df_mean$mean_on)
}

df_modis <- df_modis %>% 
  group_by(sitename) %>% 
  nest() %>% 
  mutate(data = purrr::map(data, ~separate_anom(.))) %>% 
  unnest(data)

fit_lt_modis_anom_on = lmer(off ~ scale(mean_on) + scale(anom_on) + (1|sitename) + (1|year), data = df_modis, na.action = "na.exclude")
summary(fit_lt_modis_anom_on)
plot(allEffects(fit_lt_modis_anom_on))
r.squaredGLMM(fit_lt_modis_anom_on)

aic_lt_modis_anom_on <- AIC(fit_lt_modis_anom_on)
out_lt_modis_anom_on <- allEffects(fit_lt_modis_anom_on)
gg_lt_modis_mean_on <- ggplot_mean_on(out_lt_modis_anom_on)
gg_lt_modis_anom_on <- ggplot_anom_on(out_lt_modis_anom_on)

gg_lt_modis_mean_on + gg_lt_modis_anom_on

```

## Figure 1

```{r}
ff_lt_pep_off_vs_year2 <- gg_lt_pep_off_vs_year2 +
  labs(title = expression(paste("EOS ~ ", bold("Year"), " + ", italic("A")[net])), subtitle = "PEP data and LPJ-GUESS") + 
  scale_y_continuous( limits = c(270,294),breaks = seq(270,290,10)) + 
  scale_x_continuous(limits = c(1950,2021), breaks = seq(1960,2020,20))

ff_lt_pep_off_vs_cAtot <- gg_lt_pep_off_vs_cAtot +
  labs(title = expression(paste("EOS ~ Year + ", bolditalic("A")[bold(net)])), subtitle = "PEP data and LPJ-GUESS") + 
  scale_y_continuous( limits = c(210,365),breaks = seq(240,360,40)) + 
  scale_x_continuous(limits = c(350,2400), breaks = seq(500,2400,500))

ff_iav_pep_off_vs_cAtot <- gg_iav_pep_off_vs_cAtot +
  labs(title = expression(paste("EOS ~ ", italic("A")[net])), subtitle = "PEP data and LPJ-GUESS") +
  theme(plot.background = element_rect(fill = "grey")) + 
  scale_y_continuous( limits = c(210,365),breaks = seq(240,360,40)) + 
  scale_x_continuous(limits = c(350,2400), breaks = seq(500,2400,500))

pp1 <- ff_lt_pep_off_vs_year2 + ff_lt_pep_off_vs_cAtot + ff_iav_pep_off_vs_cAtot
pp1 + plot_annotation(tag_levels = 'A')
ggsave("~/pep/manuscript/fig_1.png", width = 8, height = 3, dpi=300)
```

## Figure 2

```{r}

# Plots
ff_modis_mean_gppnet <- gg_modis_mean_gppnet +
  labs(title = expression(paste("EOS ~ ", bold("Mean "), bolditalic("A")[bold(net)], " + Anomalies ", italic("A")[net])), subtitle = "MODIS data and P-model") 

ff_modis_anom_gppnet <- gg_modis_anom_gppnet +
  labs(title = expression(paste("EOS ~ Mean ", italic("A")[net], " + " ,bold("Anomalies "), bolditalic("A")[bold(net)])), subtitle = "MODIS data and P-model") 

# Maps
lon_breaks <- seq(from = floor(min(df_anl_modis$lon)), to = ceiling(max(df_anl_modis$lon)), by = 0.1)
lat_breaks <- seq(from = floor(min(df_anl_modis$lat)), to = ceiling(max(df_anl_modis$lat)), by = 0.1)

df_modis <- df_modis %>%
  ungroup() %>%
  mutate(ilon = cut(lon,
                    breaks = lon_breaks),
         ilat = cut(lat,
                    breaks = lat_breaks)) %>%
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )) %>%
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) %>%
  
  ## create cell name to associate with climate input
  dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper)

df_modis_agg <- df_modis %>% 
  group_by(lon_mid, lat_mid) %>% 
  summarise(mean_gpp = mean(gpp_net, na.rm = TRUE),mean_eos = mean(off)) %>% 
  rename(lon = lon_mid, lat = lat_mid)

map_eos <- ggplot(data = world) + 
  geom_sf(fill= "grey",size=.3) + #antiquewhite
  #annotation_scale(location = "bl", width_hint = 0.1) + 
  #annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"), width  = unit(1, "cm"), pad_x = unit(0.1, "in"), pad_y = unit(0.1, "in"),style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-180, 180), ylim = c(15, 75), expand = F) +
  geom_point(data = df_modis_agg, aes(x = lon, y = lat, color = mean_eos),size=.3) +
  labs(color="EOS (DOY)") +
  scale_color_viridis(option="viridis",limits=c(235,342), breaks= seq(260,340,20)) +
  theme(legend.position="right", #panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue"),axis.title=element_blank(),plot.title = element_text(size = 10)) 

map_gpp <- ggplot(data = world) + 
  geom_sf(fill= "grey",size=.3) + #antiquewhite
  #annotation_scale(location = "bl", width_hint = 0.1) + 
  #annotation_north_arrow(location = "br", which_north = "true", height = unit(1, "cm"), width  = unit(1, "cm"), pad_x = unit(0.1, "in"), pad_y = unit(0.1, "in"),style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-180, 180), ylim = c(15, 75), expand = F) +
  geom_point(data = df_modis_agg, aes(x = lon, y = lat, color = mean_gpp),size=.3) +
  labs(color=expression(paste(italic("A")[net], " (gC m"^-2, " yr"^-1, ")"))) +
  scale_color_viridis(option="magma",limits=c(80,2200), breaks= seq(500,2000,500)) +
  theme(legend.position="right", #panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        panel.background = element_rect(fill = "aliceblue"),axis.title=element_blank(),plot.title = element_text(size = 10))

pp2 <- (ff_modis_mean_gppnet + ff_modis_anom_gppnet)/ map_eos / map_gpp
pp2 + plot_annotation(tag_levels = 'A') + plot_layout(heights = c(1, 1.5, 1.5),widths = c(0.5, 1.5, 1.5))
ggsave("~/pep/manuscript/fig_2.png", width = 7.5, height = 6.5, dpi=300)

```

## Supplementary Fig. S1

```{r}
ff_lt_pep_cAtot_vs_year <- gg_lt_pep_cAtot_vs_year +
  labs(title = expression(paste(italic("A")[net], " ~ Year")), subtitle = "PEP data and LPJ-GUESS")

ff_lt_pep_off_vs_year <- gg_lt_pep_off_vs_year +
  labs(title = "EOS ~ Year", subtitle = "PEP data")

ff_lt_pep_gppnet_vs_year <- gg_lt_pep_gppnet_vs_year +
  labs(title = expression(paste(italic("A")[net], " ~ Year")), subtitle = "PEP data and P-model")

ff_lt_pep_on_vs_year <- gg_lt_pep_on_vs_year +
  labs(title = "SOS ~ Year", subtitle = "PEP data")

ss1 <- (ff_lt_pep_cAtot_vs_year + ff_lt_pep_off_vs_year)/(ff_lt_pep_gppnet_vs_year + ff_lt_pep_on_vs_year)
ss1 + plot_annotation(tag_levels = 'A')
ggsave("~/pep/manuscript/fig_S1.png", width = 7.5, height = 7.5, dpi=300)
```

## Supplementary Fig. S2

```{r}
ff_lt_pep_off_vs_year3 <- gg_lt_pep_off_vs_year3 +
  labs(title = expression(paste("EOS ~ ", bold("Year"), " + ", italic("A")[net])), subtitle = "PEP data and P-model") + 
  scale_y_continuous( limits = c(276,293),breaks = seq(270,300,5)) + 
  scale_x_continuous(limits = c(1950,2021), breaks = seq(1960,2020,20))

ff_lt_pep_off_vs_gppnet <- gg_lt_pep_off_vs_gppnet +
  labs(title = expression(paste("EOS ~ Year + ", bolditalic("A")[bold(net)])), subtitle = "PEP data and P-model") + 
  scale_y_continuous( limits = c(273,300),breaks = seq(270,300,10)) + 
  scale_x_continuous(limits = c(240,1400), breaks = seq(500,1000,500))

ff_iav_pep_off_vs_gppnet <- gg_iav_pep_off_vs_gppnet +
  labs(title = expression(paste("EOS ~ ", italic("A")[net])), subtitle = "PEP data and P-model") +
  theme(plot.background = element_rect(fill = "grey")) + 
  scale_y_continuous( limits = c(278,291),breaks = seq(280,290,5)) + 
  scale_x_continuous(limits = c(200,1400), breaks = seq(500,1000,500))

ss2 <- ff_lt_pep_off_vs_year3 + ff_lt_pep_off_vs_gppnet + ff_iav_pep_off_vs_gppnet
ss2 + plot_annotation(tag_levels = 'A')
ggsave("~/pep/manuscript/fig_S2.png", width = 8, height = 3, dpi=300)
```

## Supplementary Fig. S3

```{r}
ff_lt_pep_off_vs_year1 <- gg_lt_pep_off_vs_year1 +
  labs(title = expression(paste("EOS ~ ", bold("Year"), " + SOS")), subtitle = "PEP data") 

ff_lt_pep_off_vs_on <- gg_lt_pep_off_vs_on +
  labs(title = expression(paste("EOS ~ Year + ", bold("SOS"))), subtitle = "PEP data") 

ff_iav_pep_off_vs_on <- gg_iav_pep_off_vs_on +
  labs(title = "EOS ~ SOS", subtitle = "PEP data") +
  theme(plot.background = element_rect(fill = "grey"))

ss3 <- ff_lt_pep_off_vs_year1 + ff_lt_pep_off_vs_on + ff_iav_pep_off_vs_on
ss3 + plot_annotation(tag_levels = 'A')
ggsave("~/pep/manuscript/fig_S3.png", width = 8, height = 3, dpi=300)
```

## Supplementary Fig. S4

```{r}

ff_lt_modis_mean_on <- gg_lt_modis_mean_on +
  labs(title = expression(paste("EOS ~ ", bold("Mean SOS"), " + Anomalies SOS")), subtitle = "MODIS data") 

ff_lt_modis_anom_on <- gg_lt_modis_anom_on +
  labs(title = expression(paste("EOS ~ Mean SOS + ", bold("Anomalies SOS"))), subtitle = "MODIS data") 

ss4 <- ff_lt_modis_mean_on + ff_lt_modis_anom_on
ss4 + plot_annotation(tag_levels = 'A')
ggsave("~/pep/manuscript/fig_S4.png", width = 7.5, height = 4, dpi=300)

```
