---
title: "PEP725 explorations"
author: "Beni Stocker"
date: "12/2/2020"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(broom)
library(rbeni)
library(lme4) #lmer
library(MuMIn) #r.squaredGLMM
library(lmerTest) #p-values
library(effects) #plot effects
library(sjPlot) #plot effects
do_eval <- TRUE
```

# Zani-GPP, Zani sites

## Data loading and cleaning

Read the data complemented with drivers, obtained from Constantin Zohner (7.12.2020).
```{r}
df <- data.table::fread("~/data/pep/processed/DataMeta_3_Drivers_20_11_10.csv") %>% 
  as_tibble() %>% 
  rename(lon = LON, lat = LAT, year = YEAR, off = DoY_off, on = DoY_out, 
         anom_off_zani = autumn_anomaly, anom_on_zani = spring_anomaly, 
         species = Species, id_site = PEP_ID, id_species_site = timeseries) %>% 
  
  ## use the on-water-stressed version of A
  mutate(cA_tot = `cA_tot-w`)

# ## test
# tmp <- df %>% 
#   dplyr::select(id_site, id_species_site) %>% 
#   group_by(id_site) %>% 
#   nest() %>% 
#   mutate(data = map(data, ~distinct(.)))
```

Taking uncorrected Zani
```{r}
df_anl <- df
```

## IAV

Interannual temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_cA_tot = lmer(off ~ cA_tot + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_cA_tot)
r.squaredGLMM(Fit_IAV_cA_tot)
plot(allEffects(Fit_IAV_cA_tot))
```

We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.
```{r}
remove_randomfactor <- function(df){

  # fit model
  f1 <- lmer(off ~ cA_tot + (1|id_site), data = df)

  # Predict the data, removing the grouping value
  fix.pred1 <- predict(f1, re.form = NA)

  # To remove the random effects term and view the original spread of the data
  # with just the random noise added, add the residual error back
  # onto the predicted values
  y.adj1 <- fix.pred1 + resid(f1)

  # Store results
  df$off_norandom <- y.adj1

  return(df)
}

df_anl <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_anl %>%
  analyse_modobs2("cA_tot", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200,350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# cA_tot: Interaction scale(cA_tot):scale(year) is significant and positive.
Fit_LT_cA_tot = lmer(off ~ scale(cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_cA_tot) 
plot(allEffects(Fit_LT_cA_tot))

# # cGSI
# Fit_LT_cGSI = lmer(off ~ scale(cGSI) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
# summary(Fit_LT_cGSI) 
# plot(allEffects(Fit_LT_cGSI))

# SOS - EOS
Fit_LT_on = lmer(off ~ scale(on) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_on) 
tmp <- allEffects(Fit_LT_on)
plot(tmp)
```

<!-- ```{r} -->
<!-- ggplot_on_year <- function(x){ -->

<!--   df_vis_on <- tibble(upper = x$`scale(on)`$upper[,1], -->
<!--                    lower = x$`scale(on)`$lower[,1], -->
<!--                    off = x$`scale(on)`$fit[,1], -->
<!--                    on = x$`scale(on)`$x[,1]) -->

<!--   df_vis_year <- tibble(upper = x$`scale(year)`$upper[,1], -->
<!--                 lower = x$`scale(year)`$lower[,1], -->
<!--                 off = x$`scale(year)`$fit[,1], -->
<!--                 year = x$`scale(year)`$x[,1]) -->

<!--   gg1 <- ggplot() +  -->
<!--     geom_ribbon(data = df_vis_on, aes(x = on, ymin = lower, ymax = upper), alpha = 0.2) + -->
<!--     geom_line(data = df_vis_on, aes(on, off), col = "royalblue") + -->
<!--     theme_classic() -->

<!--   gg2 <- ggplot() +  -->
<!--     geom_ribbon(data = df_vis_year, aes(x = year, ymin = lower, ymax = upper), alpha = 0.2) + -->
<!--     geom_line(data = df_vis_year, aes(year, off), col = "royalblue") + -->
<!--     theme_classic() -->

<!--   return(list(on = gg1, year = gg2)) -->
<!-- } -->

<!-- mod_on_year <- lmer(on ~ scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude") -->

<!-- df_on_year <- tibble(year = min(df_anl$year):max(df_anl$year)) %>%  -->
<!--   mutate(on = predict(mod_on_year, re.form = NA, newdata = .)) -->

<!-- gg$year <- gg$year + -->
<!--   geom_line(df_on_year, aes(year, on), color = "red") -->

<!-- library(patchwork) -->

<!-- gg0 <- df_on_year %>%  -->
<!--   mutate(year = as.double(year)) %>%  -->
<!--   ggplot() + -->
<!--   geom_line(aes(year, on), color = "red") + -->
<!--   theme_classic() -->

<!-- gg0 / (gg$on + gg$year) -->



<!-- years <- min(df_anl$year):max(df_anl$year) -->
<!-- df_vis <- expand.grid(year = years,  -->
<!--                       id_site = df_anl$id_site %>% unique(),  -->
<!--                       species = df_anl$species %>% unique(), -->
<!--                       on = median(df_anl$on)) %>%  -->
<!--   as_tibble() %>%  -->
<!--   mutate(off = predict(Fit_LT_on, re.form=NA, newdata = .)) %>%  -->
<!--   slice(1:100) %>% -->
<!--   mutate(off_upper = predictInterval(Fit_LT_on, newdata = ., -->
<!--                         which = "fixed", level = 0.95, n.sims = 1, -->
<!--                         stat = "median", type="linear.prediction", -->
<!--                         include.resid.var = TRUE)) -->

<!--   # group_by(year) %>%  -->
<!--   # summarise(off = mean(off), off_test = mean(off_upper.fit)) -->

<!-- df_vis %>%  -->
<!--   ggplot() +  -->
<!--   geom_line(aes(year, off)) + -->
<!--   geom_line(aes(year, off_upper$fit), col = "red") -->
<!-- ``` -->


Get correlation between on and off for withing species-sites => long-term temporal variation (5 bins).
```{r eval=do_eval}
df_temporal_longterm_sitepecies <- df_anl %>%
  mutate(yearbin = cut(year, breaks = 5, labels = FALSE)) %>%
  group_by(id_site, species, yearbin) %>%
  summarise(cA_tot = mean(cA_tot, na.rm = TRUE), off = mean(off, na.rm = TRUE)) %>%
  ungroup()
```

Longer-term temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_cA_tot_lt = lmer(off ~ cA_tot + (1|id_site) + (1|species) , 
                      data = df_temporal_longterm_sitepecies, 
                      na.action = "na.exclude"
                      )
summary(Fit_IAV_cA_tot_lt)
r.squaredGLMM(Fit_IAV_cA_tot_lt)
plot(allEffects(Fit_IAV_cA_tot_lt))
```

<!-- Fit individual regressions for each species and site -->
<!-- ```{r} -->
<!-- df_temporal_longterm_sitepecies <- df_temporal_longterm_sitepecies %>%  -->
<!--   group_by(id_species_site) %>% -->
<!--   nest() %>% -->
<!--   mutate(linmod = purrr::map(data, ~lm(off ~ cA_tot, data = .))) %>% -->
<!--   mutate(summ = purrr::map(linmod, ~summary(.))) %>% -->
<!--   mutate(df_coef = purrr::map(linmod, ~tidy(.))) %>% -->
<!--   mutate(coef_cA_tot = purrr::map_dbl(df_coef, ~get_coef_cA_tot(.))) %>% -->
<!--   mutate(p_value_cA_tot = purrr::map_dbl(df_coef, ~get_p_cA_tot(.))) %>% -->
<!--   dplyr::select(-linmod) %>% -->
<!--   mutate(rsq = purrr::map_dbl(summ, "r.squared"), -->
<!--          adj_rsq = purrr::map_dbl(summ, "adj.r.squared")) %>% -->
<!--   dplyr::select(-summ) -->

<!-- save(df_temporal_longterm_sitepecies, file = "data/df_temporal_longterm_sitepecies.RData") -->
<!-- ``` -->

<!-- Plot density of coefs -->
<!-- ```{r} -->
<!-- load("data/df_temporal_longterm_sitepecies.RData") -->
<!-- df_temporal_longterm_sitepecies %>% -->
<!--   ggplot(aes(coef_cA_tot, ..density..)) + -->
<!--   geom_histogram() + -->
<!--   xlim(-1,1) + -->
<!--   geom_vline(xintercept = 0, linetype = "dotted") + -->
<!--   geom_vline(xintercept = median(df_temporal_longterm$coef_cA_tot, na.rm = TRUE), color = "red", linetype = "dashed") -->
<!-- ``` -->



## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_cA_tot = mean(cA_tot, na.rm = TRUE),
              mean_cGSI = mean(cGSI, na.rm = TRUE))
  df %>% 
    mutate(mean_cA_tot = df_mean$mean_cA_tot,
           anom_cA_tot = cA_tot - df_mean$mean_cA_tot
           # mean_cGSI = df_mean$mean_cGSI,
           # anom_cGSI = cGSI - df_mean$mean_cGSI,           
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## cA_tot
Fit_LT_anom = lmer(off ~ scale(mean_cA_tot) + scale(anom_cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)

# ## cGSI
# Fit_LT_anom = lmer(off ~ scale(mean_cGSI) + scale(anom_cGSI) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
# summary(Fit_LT_anom)
# plot(allEffects(Fit_LT_anom))
# r.squaredGLMM(Fit_LT_anom)

```
Whatever I do, there is always this weird negative relationship between A and EOS at the spatial (between-site) scale.


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(cA_tot = mean(cA_tot, na.rm = TRUE), 
            off = mean(off, na.rm = TRUE)
            # cGSI = mean(cGSI, na.rm = TRUE)
            )

Fit_bySps_cA_tot = lmer(off ~ cA_tot + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_cA_tot)
plot(allEffects(Fit_bySps_cA_tot))
r.squaredGLMM(Fit_bySps_cA_tot)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.



# Zani-GPP, spatially sampled sites

## Data loading and cleaning

Read the data complemented with drivers, obtained from Constantin Zohner (7.12.2020).
```{r}
df <- data.table::fread("~/data/pep/processed/DataMeta_3_Drivers_20_11_10.csv") %>% 
  as_tibble() %>% 
  rename(lon = LON, lat = LAT, year = YEAR, off = DoY_off, on = DoY_out, 
         anom_off_zani = autumn_anomaly, anom_on_zani = spring_anomaly, 
         species = Species, id_site = PEP_ID, id_species_site = timeseries) %>% 
  
  ## use the on-water-stressed version of A
  mutate(cA_tot = `cA_tot-w`)
```

Taking uncorrected Zani
```{r}
df_anl <- df
```

Sample one time series per 0.5 deg gridcell.
```{r}
load("data/df_mine.RData")

set.seed(1982)
df_sites_sampled <- df_anl %>% 
  left_join(df_mine %>% 
              dplyr::select(id_species_site, lon, lat, lon_mid, lat_mid) %>% 
              distinct(), 
            by = c("id_species_site", "lon", "lat")) %>% 
  dplyr::select(id_species_site, lon_mid, lat_mid) %>% 
  distinct() %>% 
  group_by(lon_mid, lat_mid) %>% 
  sample_n(1)
```

Subset original data frame based on this selection.
```{r}
df_anl <- df_anl %>% 
  dplyr::filter(id_species_site %in% df_sites_sampled$id_species_site)

df_sites <- df_anl %>% 
  dplyr::select(id_site, lon, lat) %>% 
  distinct()

plot_map_simpl(lonmin = -10, lonmax = 40, latmin = 35, latmax = 70) +
  geom_point(data = df_sites, aes(x = lon, y = lat), color = "red")
```

## IAV

Interannual temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_cA_tot = lmer(off ~ cA_tot + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_cA_tot)
r.squaredGLMM(Fit_IAV_cA_tot)
plot(allEffects(Fit_IAV_cA_tot))
```

We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.
```{r}
remove_randomfactor <- function(df){

  # fit model
  f1 <- lmer(off ~ cA_tot + (1|id_site), data = df)

  # Predict the data, removing the grouping value
  fix.pred1 <- predict(f1, re.form = NA)

  # To remove the random effects term and view the original spread of the data
  # with just the random noise added, add the residual error back
  # onto the predicted values
  y.adj1 <- fix.pred1 + resid(f1)

  # Store results
  df$off_norandom <- y.adj1

  return(df)
}

df_anl <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_anl %>%
  analyse_modobs2("cA_tot", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200,350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# cA_tot: Interaction scale(cA_tot):scale(year) is significant and positive.
Fit_LT_cA_tot = lmer(off ~ scale(cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_cA_tot) 
plot(allEffects(Fit_LT_cA_tot))
```

Get correlation between on and off for withing species-sites => long-term temporal variation (5 bins).
```{r eval=do_eval}
df_temporal_longterm_sitepecies <- df_anl %>%
  mutate(yearbin = cut(year, breaks = 5, labels = FALSE)) %>%
  group_by(id_site, species, yearbin) %>%
  summarise(cA_tot = mean(cA_tot, na.rm = TRUE), off = mean(off, na.rm = TRUE)) %>%
  ungroup()
```

Longer-term temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_cA_tot_lt = lmer(off ~ cA_tot + (1|id_site) + (1|species) , 
                      data = df_temporal_longterm_sitepecies, 
                      na.action = "na.exclude"
                      )
summary(Fit_IAV_cA_tot_lt)
r.squaredGLMM(Fit_IAV_cA_tot_lt)
plot(allEffects(Fit_IAV_cA_tot_lt))
```

<!-- Fit individual regressions for each species and site -->
<!-- ```{r} -->
<!-- df_temporal_longterm_sitepecies <- df_temporal_longterm_sitepecies %>%  -->
<!--   group_by(id_species_site) %>% -->
<!--   nest() %>% -->
<!--   mutate(linmod = purrr::map(data, ~lm(off ~ cA_tot, data = .))) %>% -->
<!--   mutate(summ = purrr::map(linmod, ~summary(.))) %>% -->
<!--   mutate(df_coef = purrr::map(linmod, ~tidy(.))) %>% -->
<!--   mutate(coef_cA_tot = purrr::map_dbl(df_coef, ~get_coef_cA_tot(.))) %>% -->
<!--   mutate(p_value_cA_tot = purrr::map_dbl(df_coef, ~get_p_cA_tot(.))) %>% -->
<!--   dplyr::select(-linmod) %>% -->
<!--   mutate(rsq = purrr::map_dbl(summ, "r.squared"), -->
<!--          adj_rsq = purrr::map_dbl(summ, "adj.r.squared")) %>% -->
<!--   dplyr::select(-summ) -->

<!-- save(df_temporal_longterm_sitepecies, file = "data/df_temporal_longterm_sitepecies.RData") -->
<!-- ``` -->

<!-- Plot density of coefs -->
<!-- ```{r} -->
<!-- load("data/df_temporal_longterm_sitepecies.RData") -->
<!-- df_temporal_longterm_sitepecies %>% -->
<!--   ggplot(aes(coef_cA_tot, ..density..)) + -->
<!--   geom_histogram() + -->
<!--   xlim(-1,1) + -->
<!--   geom_vline(xintercept = 0, linetype = "dotted") + -->
<!--   geom_vline(xintercept = median(df_temporal_longterm$coef_cA_tot, na.rm = TRUE), color = "red", linetype = "dashed") -->
<!-- ``` -->



## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_cA_tot = mean(cA_tot, na.rm = TRUE),
              mean_cGSI = mean(cGSI, na.rm = TRUE))
  df %>% 
    mutate(mean_cA_tot = df_mean$mean_cA_tot,
           anom_cA_tot = cA_tot - df_mean$mean_cA_tot
           # mean_cGSI = df_mean$mean_cGSI,
           # anom_cGSI = cGSI - df_mean$mean_cGSI,           
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## cA_tot
Fit_LT_anom = lmer(off ~ scale(mean_cA_tot) + scale(anom_cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)

# ## cGSI
# Fit_LT_anom = lmer(off ~ scale(mean_cGSI) + scale(anom_cGSI) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
# summary(Fit_LT_anom)
# plot(allEffects(Fit_LT_anom))
# r.squaredGLMM(Fit_LT_anom)

```
Whatever I do, there is always this weird negative relationship between A and EOS at the spatial (between-site) scale.


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(cA_tot = mean(cA_tot, na.rm = TRUE), 
            off = mean(off, na.rm = TRUE)
            # cGSI = mean(cGSI, na.rm = TRUE)
            )

Fit_bySps_cA_tot = lmer(off ~ cA_tot + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_cA_tot)
plot(allEffects(Fit_bySps_cA_tot))
r.squaredGLMM(Fit_bySps_cA_tot)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.


# Zani-GPP, corrected EOS, Zani sites

## Data loading and cleaning

Read the data complemented with drivers, obtained from Constantin Zohner (7.12.2020).
```{r}
df_zani <- data.table::fread("~/data/pep/processed/DataMeta_3_Drivers_20_11_10.csv") %>% 
  as_tibble() %>% 
  rename(lon = LON, lat = LAT, year = YEAR, off = DoY_off, on = DoY_out, 
         anom_off_zani = autumn_anomaly, anom_on_zani = spring_anomaly, 
         species = Species, id_site = PEP_ID, id_species_site = timeseries) %>%
  
  ## use the on-water-stressed version of A
  mutate(cA_tot = `cA_tot-w`)
```

Correct Zani EOS dates
```{r}
## what does the original data say?
load("data/df_PEP725_alldata.RData") # loads 'df'
df_orig <- df %>% 
  dplyr::filter(phase_id %in% c(10, 11, 13, 95, 205)) %>% 
  mutate(pheno = ifelse(phase_id %in% c(10, 11, 13), "on", ifelse(phase_id %in% c(95, 205), "off", NA))) %>% 
  rename(id_site = s_id)

## take the mean across inconsistent duplicates. 3,223,360 -> 2,987,845 data points.
df_orig <- df_orig %>% 
  dplyr::select(id_site, species, year, pheno, day) %>% 
  group_by(id_site, species, year, pheno) %>% 
  summarise(day = round(mean(day), 0))

df_orig_wide <- df_orig %>% 
   pivot_wider(names_from = "pheno", values_from = "day")

df_anl <- df_zani %>% 
  rename(on_zani = on, off_zani = off) %>% 
  left_join(df_orig_wide, by = c("id_site", "species", "year"))

out <- df_anl %>% analyse_modobs2("off", "off_zani", type = "heat")
out$gg
```

## IAV

Interannual temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_cA_tot = lmer(off ~ cA_tot + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_cA_tot)
r.squaredGLMM(Fit_IAV_cA_tot)
plot(allEffects(Fit_IAV_cA_tot))
```

Some points have weird residuals. Remove them.
```{r}
# Analysis of residuals
ResG <- residuals(Fit_IAV_cA_tot)
FittedG <- fitted(Fit_IAV_cA_tot)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(df_anl$off ~ FittedG, xlab="Fitted", ylab="Observed", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")
```

```{r}
df_anl <- df_anl %>% 
  ungroup() %>% 
  mutate(res = residuals(Fit_IAV_cA_tot), fit = fitted(Fit_IAV_cA_tot)) %>% 
  mutate(off_fit = FittedG) %>% 
  rowwise() %>% 
  mutate(cluster = ifelse( (abs(off - off_fit) > 40) & off_fit > 300, "bad", "good")) %>% 
  ungroup()

df_anl %>% 
  ggplot(aes(x = off_fit, y = off, color = cluster)) +
  geom_point()
```

<!-- DON'T REMOVE THEM -->

```{r}
print(nrow(df_anl))
df_anl <- df_anl %>%
  dplyr::filter(cluster == "good")
print(nrow(df_anl))
```


We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.
```{r}
remove_randomfactor <- function(df){

  # fit model
  f1 <- lmer(off ~ cA_tot + (1|id_site), data = df)

  # Predict the data, removing the grouping value
  fix.pred1 <- predict(f1, re.form = NA)

  # To remove the random effects term and view the original spread of the data
  # with just the random noise added, add the residual error back
  # onto the predicted values
  y.adj1 <- fix.pred1 + resid(f1)

  # Store results
  df$off_norandom <- y.adj1

  return(df)
}

df_anl <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_anl %>%
  analyse_modobs2("cA_tot", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200, 350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# cA_tot: Interaction scale(cA_tot):scale(year) is significant and positive.
Fit_LT_cA_tot = lmer(off ~ scale(cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_cA_tot) 
plot(allEffects(Fit_LT_cA_tot))

# # cGSI
# Fit_LT_cGSI = lmer(off ~ scale(cGSI) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
# summary(Fit_LT_cGSI) 
# plot(allEffects(Fit_LT_cGSI))

```

## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_cA_tot = mean(cA_tot, na.rm = TRUE),
              mean_cGSI = mean(cGSI, na.rm = TRUE))
  df %>% 
    mutate(mean_cA_tot = df_mean$mean_cA_tot,
           anom_cA_tot = cA_tot - df_mean$mean_cA_tot
           # mean_cGSI = df_mean$mean_cGSI,
           # anom_cGSI = cGSI - df_mean$mean_cGSI,           
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## cA_tot
Fit_LT_anom = lmer(off ~ scale(mean_cA_tot) + scale(anom_cA_tot) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)

# ## cGSI
# Fit_LT_anom = lmer(off ~ scale(mean_cGSI) + scale(anom_cGSI) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
# summary(Fit_LT_anom)
# plot(allEffects(Fit_LT_anom))
# r.squaredGLMM(Fit_LT_anom)

```
Whatever I do, there is always this weird negative relationship between A and EOS at the spatial (between-site) scale.


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(cA_tot = mean(cA_tot, na.rm = TRUE), 
            off = mean(off, na.rm = TRUE)
            # cGSI = mean(cGSI, na.rm = TRUE)
            )

Fit_bySps_cA_tot = lmer(off ~ cA_tot + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_cA_tot)
plot(allEffects(Fit_bySps_cA_tot))
r.squaredGLMM(Fit_bySps_cA_tot)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.



# P-model-GPP, Zani sites

GPP is based on corrected SOS dates.

## Data loading

Add GPP from P-model siulations.
```{r}
load("data/df_pmodel_zani.RData")

df_anl <- df_pmodel_zani %>% 
  unnest(out_pmodel) %>% 
  right_join(df_anl, by = c("id_species_site", "year")) %>% 
  mutate(gpp_net = gpp - rd,
         lue = gpp / apar)
```

Check consistency of P-model and LPJ-GUESS GPP.
```{r}
out <- df_anl %>% 
  analyse_modobs2("cA_tot", "gpp_net", type = "heat")
out$gg
```

## IAV 

With GPP from P-model: positive!
```{r}
Fit_IAV_gpp = lmer(off ~ gpp_net + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_gpp)
r.squaredGLMM(Fit_IAV_gpp)
plot(allEffects(Fit_IAV_gpp))
```


We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.

Do the same with GPP from P-model.
```{r}
remove_randomfactor <- function(df){

  df <- df %>% 
    dplyr::filter(!is.na(gpp_net))
  
  if (nrow(df) > 30){
    # fit model
    f1 <- lmer(off ~ gpp_net + (1|id_site), data = df)

    # Predict the data, removing the grouping value
    fix.pred1 <- predict(f1, re.form = NA)

    # To remove the random effects term and view the original spread of the data
    # with just the random noise added, add the residual error back
    # onto the predicted values
    y.adj1 <- fix.pred1 + resid(f1)

    # Store results
    df$off_norandom <- y.adj1 
  } else {
    df$off_norandom <- NA
  }

  return(df)
}

df_tmp <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_tmp %>%
  analyse_modobs2("gpp_net", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200, 350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# P-model GPP
Fit_LT_gpp = lmer(off ~ scale(gpp_net) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_gpp) 
plot(allEffects(Fit_LT_gpp))
```

## LUE vs APAR

(P-model only)

Separation of GPP in LUE and APAR.
```{r}
# P-model LUE and APAR (no time!)
Fit_LT_lue = lmer(off ~ scale(lue) + scale(apar) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_lue) 
plot(allEffects(Fit_LT_lue))
plot_model(Fit_LT_lue, type = "eff", terms = c("gpp", "lue[2020,1960,1890]"), title = "",axis.title = c("gpp","off"), legend.title = "lue") + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom") 
r.squaredGLMM(Fit_LT_lue)
```

## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_gpp_net = mean(gpp_net, na.rm = TRUE))
  df %>% 
    mutate(mean_gpp_net = df_mean$mean_gpp_net,
           anom_gpp_net = gpp_net - df_mean$mean_gpp_net
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## gpp_net
Fit_LT_anom = lmer(off ~ scale(mean_gpp_net) + scale(anom_gpp_net) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)
```


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(gpp_net = mean(gpp_net, na.rm = TRUE),
            off = mean(off, na.rm = TRUE))

Fit_bySps_gpp_net = lmer(off ~ gpp_net + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_gpp_net)
plot(allEffects(Fit_bySps_gpp_net))
r.squaredGLMM(Fit_bySps_gpp_net)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.

# P-model-GPP, sampled sites

GPP is based on corrected SOS dates.
Spatially sampled sites.

When using un-sampled sites, results look ~identical to using Zani sites.

## Data loading

Add GPP from P-model simulations
```{r}
load("data/df_mine.RData")
load("data/df_pmodel_mine.RData")

df_anl <- df_pmodel_zani %>% 
  unnest(out_pmodel) %>% 
  right_join(df_mine, by = c("id_species_site", "year", "lon_mid", "lat_mid")) %>% 
  mutate(gpp_net = gpp - rd,
         lue = gpp / apar) %>% 
  rename(id_site = s_id)
```

Sample one time series per 0.5 deg gridcell.
```{r}
set.seed(189)
df_sites_sampled <- df_anl %>% 
  dplyr::select(id_species_site, lon_mid, lat_mid) %>% 
  distinct() %>% 
  group_by(lon_mid, lat_mid) %>% 
  sample_n(1)
```

Subset original data frame based on this selection.
```{r}
df_anl <- df_anl %>% 
  dplyr::filter(id_species_site %in% df_sites_sampled$id_species_site)

# test : should have ~19.000 rows - ok
df_sites <- df_anl %>% 
  dplyr::select(id_site, lon, lat, elv) %>% 
  distinct()

plot_map_simpl(lonmin = -10, lonmax = 40, latmin = 35, latmax = 70) +
  geom_point(data = df_sites, aes(x = lon, y = lat, color = elv)) +
  scale_color_viridis_c()
```

## IAV 

With GPP from P-model: positive!
```{r}
Fit_IAV_gpp = lmer(off ~ gpp_net + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_gpp)
r.squaredGLMM(Fit_IAV_gpp)
plot(allEffects(Fit_IAV_gpp))
```


We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.

Do the same with GPP from P-model.
```{r}
remove_randomfactor <- function(df){

  df <- df %>% 
    dplyr::filter(!is.na(gpp_net))
  
  if (nrow(df) > 30){
    # fit model
    f1 <- lmer(off ~ gpp_net + (1|id_site), data = df)

    # Predict the data, removing the grouping value
    fix.pred1 <- predict(f1, re.form = NA)

    # To remove the random effects term and view the original spread of the data
    # with just the random noise added, add the residual error back
    # onto the predicted values
    y.adj1 <- fix.pred1 + resid(f1)

    # Store results
    df$off_norandom <- y.adj1 
  } else {
    df$off_norandom <- NA
  }

  return(df)
}

df_tmp <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_tmp %>%
  analyse_modobs2("gpp_net", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200, 350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# P-model GPP
Fit_LT_gpp = lmer(off ~ scale(gpp_net) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_gpp) 
plot(allEffects(Fit_LT_gpp))
```

## LUE vs APAR

(P-model only)

Separation of GPP in LUE and APAR.
```{r}
# P-model LUE and APAR (no time!)
Fit_LT_lue = lmer(off ~ scale(lue) + scale(apar) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_lue) 
plot(allEffects(Fit_LT_lue))
plot_model(Fit_LT_lue, type = "eff", terms = c("gpp", "lue[2020,1960,1890]"), title = "",axis.title = c("gpp","off"), legend.title = "lue") + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom") 
r.squaredGLMM(Fit_LT_lue)
```

## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_gpp_net = mean(gpp_net, na.rm = TRUE))
  df %>% 
    mutate(mean_gpp_net = df_mean$mean_gpp_net,
           anom_gpp_net = gpp_net - df_mean$mean_gpp_net
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## gpp_net
Fit_LT_anom = lmer(off ~ scale(mean_gpp_net) + scale(anom_gpp_net) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)
```


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(gpp_net = mean(gpp_net, na.rm = TRUE),
            off = mean(off, na.rm = TRUE))

Fit_bySps_gpp_net = lmer(off ~ gpp_net + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_gpp_net)
plot(allEffects(Fit_bySps_gpp_net))
r.squaredGLMM(Fit_bySps_gpp_net)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.

# Re-calculated net GPP from LPJ, Zani sites

## Data loading and cleaning

Re-calculated from daily outputs sent by Constantin 5.3.2021. This file is produced in `zanitest.Rmd`

Rearrange LPJ output dataframe.
```{r}
rm("df_orig")
rm("df_orig_wide")

## GPP
df_lpj <- read_csv("data/daily_GPP_data_20210305.csv") %>% 
  pivot_longer(cols = 6:ncol(.), names_to = "doy", names_prefix = "V", values_to = "gpp_lpj") %>%
  mutate(doy = as.integer(doy)) %>%
  mutate(date = lubridate::ymd(paste0(as.character(year), "-01-01")) + lubridate::days(doy-1))
save(df_lpj, file = "data/df_lpj.RData")
rm("df_lpj")

## Rd
df_lpj_rd <- read_csv("data/daily_Rd_data_20210305.csv") %>% 
  pivot_longer(cols = 6:ncol(.), names_to = "doy", names_prefix = "V", values_to = "rd_lpj") %>%
  mutate(doy = as.integer(doy)) %>%
  mutate(date = lubridate::ymd(paste0(as.character(year), "-01-01")) + lubridate::days(doy-1))
save(df_lpj_rd, file = "data/df_lpj_rd.RData")
```

Split into separate files by pep_id.
```{r}
load("data/df_lpj.RData")
load("data/df_lpj_rd.RData")

df_lpj <- df_lpj %>% 
  dplyr::select(pep_id, lat, date, gpp_lpj) %>% 
  left_join(df_lpj_rd %>% 
              dplyr::select(pep_id, date, rd_lpj),
            by = c("date", "pep_id")
            ) %>% 
  mutate(gpp_lpj_net = gpp_lpj - rd_lpj, year = lubridate::year(date), doy = lubridate::yday(date)) %>% 
  mutate(dayl = geosphere::daylength(lat = lat, doy = doy))
rm("df_lpj_rd")

## split into separate files by pep_id
for (idx in unique(df_lpj$pep_id)){
  df <- df_lpj %>% 
    ungroup() %>% 
    dplyr::filter(pep_id == idx)
  save(df, file = paste0("data/df_lpj_pep_id_", as.character(idx), ".RData"))
}
rm("df_lpj")
```

Aggregate to annual, using pheno dates for each year.
```{r}
df_years <- data.table::fread("~/data/pep/processed/DataMeta_3_Drivers_20_11_10.csv") %>% 
  as_tibble() %>% 
  select(year = YEAR, off = DoY_off, on = DoY_out, 
         species = Species, pep_id = PEP_ID, id_species_site = timeseries)

## aggregate to annual
agg_by_pep <- function(use_pep_id, df_yr){
  ## combine time-series-level info for each year and pep-id-level info for each day (lpj outputs)
  ## ... and aggregate to annual values for each species of this pep_id
  filn <- paste0("data/df_lpj_pep/df_lpj_pep_id_", as.character(use_pep_id), ".RData")
  if (file.exists(filn)){
    load(filn)
    df %>% 
      ungroup() %>% 
      dplyr::filter(pep_id == use_pep_id) %>% 
      full_join(df_yr,
                by = "year") %>% 
      arrange(species, date) %>% 
  
      ## set gpp to zero after day length = 11 h
      mutate(gpp_lpj = ifelse(dayl < 11 & doy > lubridate::yday("21-06-2001"), 0, gpp_lpj),
             gpp_lpj_net = ifelse(dayl < 11 & doy > lubridate::yday("21-06-2001"), 0, gpp_lpj_net)) %>% 
      
      ## XXX test without this step -> df_anl_lpj_test.RData XXX
      # ## set gpp before leaf onset to zero
      # mutate(gpp_lpj = ifelse(doy < on, 0, gpp_lpj),
      #        gpp_lpj_net = ifelse(doy < on, 0, gpp_lpj_net)) %>% 
      
      group_by(year, id_species_site) %>% 
      summarise(gpp_lpj = sum(gpp_lpj, na.rm = TRUE), gpp_lpj_net = sum(gpp_lpj_net, na.rm = TRUE)) %>% 
      arrange(id_species_site, year)
  } else {
    tibble()
  }

}

df_tmp <- df_years %>% 
  group_by(pep_id) %>% 
  nest()

## hopefully this will not exhaust memory
df_anl <- tibble()
for (idx in seq(nrow(df_tmp))){
  df_anl <- df_tmp %>% 
    ungroup() %>% 
    slice(idx) %>% 
    mutate(data = purrr::map2(pep_id, data, ~agg_by_pep(.x, .y))) %>% 
    bind_rows(df_anl, .)
}

df_anl <- df_anl %>% 
  drop_na() %>% 
  mutate(data = purrr::map(data, ~ungroup(.))) %>% 
  unnest(data) %>% 
  left_join(df_years,
            by = c("id_species_site", "year", "pep_id")) %>% 
  rename(id_site = pep_id)
save(df_anl, file = "data/df_anl_lpj_test.RData")
```

## IAV

Interannual temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_gpp_lpj_net = lmer(off ~ gpp_lpj_net + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_gpp_lpj_net)
r.squaredGLMM(Fit_IAV_gpp_lpj_net)
plot(allEffects(Fit_IAV_gpp_lpj_net))
```

We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.
```{r}
remove_randomfactor <- function(df){

  # fit model
  f1 <- try(lmer(off ~ gpp_lpj_net + (1|id_site), data = df))
    
  if (class(f1) != "try-error"){
    
    # Predict the data, removing the grouping value
    fix.pred1 <- predict(f1, re.form = NA)
  
    # To remove the random effects term and view the original spread of the data
    # with just the random noise added, add the residual error back
    # onto the predicted values
    y.adj1 <- fix.pred1 + resid(f1)
  
    # Store results
    df$off_norandom <- y.adj1
      
  } else {
    df <- tibble()
  }

  return(df)
}

df_anl <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_anl %>%
  analyse_modobs2("gpp_lpj_net", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200,350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# gpp_lpj_net: Interaction scale(gpp_lpj_net):scale(year) is significant and positive.
Fit_LT_gpp_lpj_net = lmer(off ~ scale(gpp_lpj_net) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_gpp_lpj_net) 
plot(allEffects(Fit_LT_gpp_lpj_net))
```

Get correlation between on and off for withing species-sites => long-term temporal variation (5 bins).
```{r eval=do_eval}
df_temporal_longterm_sitepecies <- df_anl %>%
  mutate(yearbin = cut(year, breaks = 5, labels = FALSE)) %>%
  group_by(id_site, species, yearbin) %>%
  summarise(gpp_lpj_net = mean(gpp_lpj_net, na.rm = TRUE), off = mean(off, na.rm = TRUE)) %>%
  ungroup()
```

Longer-term temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_gpp_lpj_net_lt = lmer(off ~ gpp_lpj_net + (1|id_site) + (1|species) , 
                      data = df_temporal_longterm_sitepecies, 
                      na.action = "na.exclude"
                      )
summary(Fit_IAV_gpp_lpj_net_lt)
r.squaredGLMM(Fit_IAV_gpp_lpj_net_lt)
plot(allEffects(Fit_IAV_gpp_lpj_net_lt))
```

<!-- Fit individual regressions for each species and site -->
<!-- ```{r} -->
<!-- df_temporal_longterm_sitepecies <- df_temporal_longterm_sitepecies %>%  -->
<!--   group_by(id_species_site) %>% -->
<!--   nest() %>% -->
<!--   mutate(linmod = purrr::map(data, ~lm(off ~ gpp_lpj_net, data = .))) %>% -->
<!--   mutate(summ = purrr::map(linmod, ~summary(.))) %>% -->
<!--   mutate(df_coef = purrr::map(linmod, ~tidy(.))) %>% -->
<!--   mutate(coef_gpp_lpj_net = purrr::map_dbl(df_coef, ~get_coef_gpp_lpj_net(.))) %>% -->
<!--   mutate(p_value_gpp_lpj_net = purrr::map_dbl(df_coef, ~get_p_gpp_lpj_net(.))) %>% -->
<!--   dplyr::select(-linmod) %>% -->
<!--   mutate(rsq = purrr::map_dbl(summ, "r.squared"), -->
<!--          adj_rsq = purrr::map_dbl(summ, "adj.r.squared")) %>% -->
<!--   dplyr::select(-summ) -->

<!-- save(df_temporal_longterm_sitepecies, file = "data/df_temporal_longterm_sitepecies.RData") -->
<!-- ``` -->

<!-- Plot density of coefs -->
<!-- ```{r} -->
<!-- load("data/df_temporal_longterm_sitepecies.RData") -->
<!-- df_temporal_longterm_sitepecies %>% -->
<!--   ggplot(aes(coef_gpp_lpj_net, ..density..)) + -->
<!--   geom_histogram() + -->
<!--   xlim(-1,1) + -->
<!--   geom_vline(xintercept = 0, linetype = "dotted") + -->
<!--   geom_vline(xintercept = median(df_temporal_longterm$coef_gpp_lpj_net, na.rm = TRUE), color = "red", linetype = "dashed") -->
<!-- ``` -->



## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1970:2000) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_gpp_lpj_net = mean(gpp_lpj_net, na.rm = TRUE))
  df %>% 
    mutate(mean_gpp_lpj_net = df_mean$mean_gpp_lpj_net,
           anom_gpp_lpj_net = gpp_lpj_net - df_mean$mean_gpp_lpj_net
           # mean_cGSI = df_mean$mean_cGSI,
           # anom_cGSI = cGSI - df_mean$mean_cGSI,           
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## gpp_lpj_net
Fit_LT_anom = lmer(off ~ scale(mean_gpp_lpj_net) + scale(anom_gpp_lpj_net) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)
```
Whatever I do, there is always this weird negative relationship between A and EOS at the spatial (between-site) scale.


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(gpp_lpj_net = mean(gpp_lpj_net, na.rm = TRUE), 
            off = mean(off, na.rm = TRUE)
            # cGSI = mean(cGSI, na.rm = TRUE)
            )

Fit_bySps_gpp_lpj_net = lmer(off ~ gpp_lpj_net + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_gpp_lpj_net)
plot(allEffects(Fit_bySps_gpp_lpj_net))
r.squaredGLMM(Fit_bySps_gpp_lpj_net)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.



# Re-calculated gross GPP from LPJ, Zani sites

```{r}
load("data/df_anl_lpj.RData")
df_anl <- df_anl %>% 
  rename(id_site = pep_id)
```

## IAV

Interannual temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_gpp_lpj = lmer(off ~ gpp_lpj + (1|id_site) + (1|species) , data = df_anl, na.action = "na.exclude")
summary(Fit_IAV_gpp_lpj)
r.squaredGLMM(Fit_IAV_gpp_lpj)
plot(allEffects(Fit_IAV_gpp_lpj))
```

We can re-create Fig. 1A in Zani et al. This shows correlation of points, pooling data from all species, and after "removing" the random factor 'site'. This essentially removes the spatial variation! This uses code adopted from `ModelAnalyses_1_Correlation&PathAnalyses_Figures1.R`.
```{r}
remove_randomfactor <- function(df){

  # fit model
  f1 <- try(lmer(off ~ gpp_lpj + (1|id_site), data = df))
    
  if (class(f1) != "try-error"){
    
    # Predict the data, removing the grouping value
    fix.pred1 <- predict(f1, re.form = NA)
  
    # To remove the random effects term and view the original spread of the data
    # with just the random noise added, add the residual error back
    # onto the predicted values
    y.adj1 <- fix.pred1 + resid(f1)
  
    # Store results
    df$off_norandom <- y.adj1
      
  } else {
    df <- tibble()
  }

  return(df)
}

df_anl <- df_anl %>%
  group_by(species) %>%
  nest() %>%
  mutate(data = map(data, ~remove_randomfactor(.))) %>%
  unnest(data)

out <- df_anl %>%
  analyse_modobs2("gpp_lpj", "off_norandom", type = "heat")
out$gg +
  coord_cartesian(ylim = c(200,350))
```


## Long-term

Separating the temporal trends from the relationship with A using LMMs. Without interactions between A and year.
```{r}
# gpp_lpj: Interaction scale(gpp_lpj):scale(year) is significant and positive.
Fit_LT_gpp_lpj = lmer(off ~ scale(gpp_lpj) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_gpp_lpj) 
plot(allEffects(Fit_LT_gpp_lpj))
```

Get correlation between on and off for withing species-sites => long-term temporal variation (5 bins).
```{r eval=do_eval}
df_temporal_longterm_sitepecies <- df_anl %>%
  mutate(yearbin = cut(year, breaks = 5, labels = FALSE)) %>%
  group_by(id_site, species, yearbin) %>%
  summarise(gpp_lpj = mean(gpp_lpj, na.rm = TRUE), off = mean(off, na.rm = TRUE)) %>%
  ungroup()
```

Longer-term temporal variation with LMMs
```{r}
# Both models are equivalent
Fit_IAV_gpp_lpj_lt = lmer(off ~ gpp_lpj + (1|id_site) + (1|species) , 
                      data = df_temporal_longterm_sitepecies, 
                      na.action = "na.exclude"
                      )
summary(Fit_IAV_gpp_lpj_lt)
r.squaredGLMM(Fit_IAV_gpp_lpj_lt)
plot(allEffects(Fit_IAV_gpp_lpj_lt))
```

<!-- Fit individual regressions for each species and site -->
<!-- ```{r} -->
<!-- df_temporal_longterm_sitepecies <- df_temporal_longterm_sitepecies %>%  -->
<!--   group_by(id_species_site) %>% -->
<!--   nest() %>% -->
<!--   mutate(linmod = purrr::map(data, ~lm(off ~ gpp_lpj, data = .))) %>% -->
<!--   mutate(summ = purrr::map(linmod, ~summary(.))) %>% -->
<!--   mutate(df_coef = purrr::map(linmod, ~tidy(.))) %>% -->
<!--   mutate(coef_gpp_lpj = purrr::map_dbl(df_coef, ~get_coef_gpp_lpj(.))) %>% -->
<!--   mutate(p_value_gpp_lpj = purrr::map_dbl(df_coef, ~get_p_gpp_lpj(.))) %>% -->
<!--   dplyr::select(-linmod) %>% -->
<!--   mutate(rsq = purrr::map_dbl(summ, "r.squared"), -->
<!--          adj_rsq = purrr::map_dbl(summ, "adj.r.squared")) %>% -->
<!--   dplyr::select(-summ) -->

<!-- save(df_temporal_longterm_sitepecies, file = "data/df_temporal_longterm_sitepecies.RData") -->
<!-- ``` -->

<!-- Plot density of coefs -->
<!-- ```{r} -->
<!-- load("data/df_temporal_longterm_sitepecies.RData") -->
<!-- df_temporal_longterm_sitepecies %>% -->
<!--   ggplot(aes(coef_gpp_lpj, ..density..)) + -->
<!--   geom_histogram() + -->
<!--   xlim(-1,1) + -->
<!--   geom_vline(xintercept = 0, linetype = "dotted") + -->
<!--   geom_vline(xintercept = median(df_temporal_longterm$coef_gpp_lpj, na.rm = TRUE), color = "red", linetype = "dashed") -->
<!-- ``` -->



## Anomalies

Let's try to separate annual anomalies and site-level mean (of years 1970-2000).
```{r}
separate_anom <- function(df){
  df_mean <- df %>% 
    dplyr::filter(year %in% 1975:1995) %>% 
    summarise(mean_off = mean(off, na.rm = TRUE), 
              mean_gpp_lpj = mean(gpp_lpj, na.rm = TRUE))
  df %>% 
    mutate(mean_gpp_lpj = df_mean$mean_gpp_lpj,
           anom_gpp_lpj = gpp_lpj - df_mean$mean_gpp_lpj
           # mean_cGSI = df_mean$mean_cGSI,
           # anom_cGSI = cGSI - df_mean$mean_cGSI,           
           )
}
df_anl <- df_anl %>% 
  group_by(id_species_site) %>% 
  nest() %>% 
  mutate(data = map(data, ~separate_anom(.))) %>% 
  unnest(data)

## gpp_lpj
Fit_LT_anom = lmer(off ~ scale(mean_gpp_lpj) + scale(anom_gpp_lpj) + scale(year) + (1|id_site) + (1|species), data = df_anl, na.action = "na.exclude")
summary(Fit_LT_anom)
plot(allEffects(Fit_LT_anom))
r.squaredGLMM(Fit_LT_anom)
```
Whatever I do, there is always this weird negative relationship between A and EOS at the spatial (between-site) scale.


## Spatial by species

Aggregate years, to get a "spatial" data frame, distinguishing species.
```{r}
df_spatial_sps <- df_anl %>% 
  group_by(id_site, species) %>% 
  summarise(gpp_lpj = mean(gpp_lpj, na.rm = TRUE), 
            off = mean(off, na.rm = TRUE)
            # cGSI = mean(cGSI, na.rm = TRUE)
            )

Fit_bySps_gpp_lpj = lmer(off ~ gpp_lpj + (1|species), data = df_spatial_sps, na.action = "na.exclude")
summary(Fit_bySps_gpp_lpj)
plot(allEffects(Fit_bySps_gpp_lpj))
r.squaredGLMM(Fit_bySps_gpp_lpj)
```
There is still a negative relationship between EOS and A, but not with GPP from P-model.



